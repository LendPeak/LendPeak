<!-- bills.component.html -->
<!-- Bills Tab Content -->
<div class="grid">
  <div class="col-12">
    <p-card>
      <p-toolbar styleClass="mb-4 gap-2">
        <ng-template pTemplate="left">
          <p-button
            label="Go to Last Due Bill"
            icon="pi pi-arrow-down"
            (click)="scrollToLastDueBill()"
            pTooltip="Scroll to the last due (unpaid) bill and highlight it"
          ></p-button>
        </ng-template>
      </p-toolbar>

      <p-table
        [value]="bills.all"
        sortField="dueDate"
        [scrollable]="true"
        scrollHeight="600px"
      >
        <ng-template #header>
          <tr>
            <th pSortableColumn="id">
              Bill ID
              <p-sortIcon field="id"></p-sortIcon>
            </th>
            <th pSortableColumn="period">
              Period
              <p-sortIcon field="period"></p-sortIcon>
            </th>
            <th pSortableColumn="dueDate">
              Due Date
              <p-sortIcon field="dueDate"></p-sortIcon>
            </th>
            <th>Principal Due</th>
            <th>Interest Due</th>
            <th>Fees Due</th>
            <th>Total Due</th>
            <th>Satisfied On</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </ng-template>

        <ng-template #body let-bill let-rowIndex="rowIndex">
          <tr #billRow [class.selected-row]="isBillHighlighted(bill)">
            <td>
              {{ bill.id }}

              <!-- Show a tag if there is more than 1 payment for this bill -->
              <p-tag
                *ngIf="bill.paymentDetails?.length > 1"
                value="{{ bill.paymentDetails.length + ' Payments' }}"
                severity="warn"
                styleClass="ml-2"
                pTooltip="This bill was satisfied by multiple payments"
                tooltipPosition="top"
              >
              </p-tag>
            </td>
            <td>{{ bill.period }}</td>
            <td>{{ bill.jsDueDate | date: "MM/dd/yyyy" }}</td>
            <td>{{ bill.jsPrincipalDue | currency }}</td>
            <td>{{ bill.jsInterestDue | currency }}</td>
            <td>{{ bill.jsFeesDue | currency }}</td>
            <td>{{ bill.jsTotalDue | currency }}</td>
            <td>
              <!-- Only show if the bill is paid and we have a satisfied date -->
              <ng-container *ngIf="bill.isPaid && bill.dateFullySatisfied">
                <!-- Display date satisfied -->
                <span class="mr-3">{{
                  bill.dateFullySatisfied | date: "MM/dd/yyyy"
                }}</span>

                <!-- Show how many days late/early in a p-tag -->
                <ng-container *ngIf="bill.daysLate > 0">
                  <p-tag
                    value="{{ bill.daysLate + ' Days Late' }}"
                    severity="warn"
                    class="status-tag"
                  ></p-tag>
                </ng-container>

                <ng-container *ngIf="bill.daysEarly > 0">
                  <p-tag
                    value="{{ bill.daysEarly + ' Days Early' }}"
                    severity="success"
                    class="status-tag"
                  ></p-tag>
                </ng-container>

                <!-- If daysLate = 0 & daysEarly = 0, then it's on-time -->
                <ng-container *ngIf="!bill.daysLate && !bill.daysEarly">
                  <p-tag
                    value="On-Time"
                    severity="info"
                    class="status-tag"
                  ></p-tag>
                </ng-container>
              </ng-container>
            </td>

            <td>
              <!-- Existing Status Tags -->
              <p-tag
                *ngIf="bill.isOpen && !bill.isPaid"
                value="Open Bill"
                severity="success"
                class="status-tag"
              ></p-tag>
              <p-tag
                *ngIf="!bill.isOpen && !bill.isPaid"
                value="Future"
                severity="info"
                class="status-tag"
              ></p-tag>
              <p-tag
                *ngIf="bill.jsTotalDue == 0"
                value="Skip A Pay"
                severity="secondary"
                class="status-tag"
              ></p-tag>
              <p-tag
                *ngIf="bill.jsTotalDue > 0"
                value="{{ bill.isPaid ? 'Paid' : 'Unpaid' }}"
                [severity]="bill.isPaid ? 'success' : 'warn'"
                class="status-tag"
              ></p-tag>
              <p-tag
                *ngIf="bill.isPastDue && !bill.isPaid"
                value="{{ bill.daysPastDue }} Days Past Due"
                severity="danger"
                class="status-tag"
              ></p-tag>
            </td>

            <td>
              <p-button
                label="View Payment Details"
                icon="pi pi-eye"
                [disabled]="
                  !bill.paymentDetails || bill.paymentDetails.length === 0
                "
                (click)="viewPaymentDetails(bill)"
              ></p-button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>
</div>

<!-- Payment Details Dialog -->
<p-dialog
  header="Payment Details"
  [(visible)]="showPaymentDetailsDialog"
  [modal]="true"
  [style]="{ width: '70%' }"
  [closable]="true"
  (onHide)="onPaymentDetailsDialogHide()"
>
  <p-table [value]="selectedBill?.paymentDetails || []">
    <ng-template #header>
      <tr>
        <th>Deposit ID</th>
        <th>Deposit Amount</th>
        <th>Date</th>
        <th>Allocated Total</th>
        <th>Allocated Principal</th>
        <th>Allocated Interest</th>
        <th>Allocated Fees</th>
      </tr>

      <!-- Original row: how much was allocated in total -->
      <tr>
        <th class="bg-blue-50"></th>
        <th class="bg-blue-50"></th>
        <th class="bg-blue-50 text-right">Original Bill:</th>
        <th class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsOriginalTotalDue | currency }}
        </th>
        <th class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsOriginalPrincipalDue | currency }}
        </th>
        <th class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsOriginalInterestDue | currency }}
        </th>
        <th class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsOriginalFeesDue | currency }}
        </th>
      </tr>
    </ng-template>

    <ng-template #body let-detail>
      <tr>
        <td>
          <p-button
            (click)="viewSinglePaymentDetail(detail)"
            icon="pi pi-search"
            [rounded]="true"
            [text]="true"
            severity="success"
            class="pr-2"
          />

          {{ detail.depositId }}
        </td>
        <td>
          {{ depositRecords.getById(detail.depositId)?.jsAmount | currency }}
        </td>
        <td>{{ detail.jsDate | date: "MM/dd/yyyy" }}</td>
        <td>{{ detail.jsAllocatedTotal | currency }}</td>
        <td>{{ detail.jsAllocatedPrincipal | currency }}</td>
        <td>{{ detail.jsAllocatedInterest | currency }}</td>
        <td>{{ detail.jsAllocatedFees | currency }}</td>
      </tr>
    </ng-template>

    <ng-template #footer>
      <!-- Totals row: how much was allocated in total -->
      <tr>
        <td
          class="bg-blue-50"
          colspan="3"
          style="text-align: right; font-weight: bold"
        >
          Allocated:
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsAllocatedTotalSum | currency }}
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsAllocatedPrincipalSum | currency }}
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsAllocatedInterestSum | currency }}
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsAllocatedFeesSum | currency }}
        </td>
      </tr>

      <!-- Remaining row: original minus allocated -->
      <tr>
        <td
          class="bg-blue-50"
          colspan="3"
          style="text-align: right; font-weight: bold"
        >
          Remaining:
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsRemainingTotal | currency }}
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsRemainingPrincipal | currency }}
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsRemainingInterest | currency }}
        </td>
        <td class="bg-blue-50" style="font-weight: bold">
          {{ selectedBill?.jsRemainingFees | currency }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>

<!-- Single Payment/Deposit Display Dialog (Non-blocking and Draggable) -->
<p-dialog
  header="Payment Card"
  [(visible)]="showSinglePaymentDialog"
  [modal]="false"
  [draggable]="true"
  [resizable]="true"
  [style]="{ width: '500px' }"
  (onHide)="selectedPaymentDeposit = null"
>
  <ng-container *ngIf="selectedPaymentDeposit">
    <p-card
      title="Payment ID: {{ selectedPaymentDeposit.id }}"
      class="w-full"
      [style]="{ 'margin-bottom': '1rem' }"
    >
      <p class="m-0">
        <strong>Amount:</strong>
        <span>{{ selectedPaymentDeposit.jsAmount | currency }}</span>
      </p>
      <p class="m-0">
        <strong>Effective Date:</strong>
        <span>{{
          selectedPaymentDeposit.jsEffectiveDate | date: "MM/dd/yyyy"
        }}</span>
      </p>
      <p class="m-0">
        <strong>Clearing Date:</strong>
        <span>{{
          selectedPaymentDeposit.jsClearingDate | date: "MM/dd/yyyy"
        }}</span>
      </p>
      <p class="m-0">
        <strong>Unused Amount:</strong>
        <span>{{ selectedPaymentDeposit.jsUnusedAmount | currency }}</span>
      </p>
      <p class="m-0">
        <strong>Apply Excess to Principal:</strong>
        <span>{{
          selectedPaymentDeposit.applyExcessToPrincipal ? "Yes" : "No"
        }}</span>
      </p>
      <p class="m-0">
        <strong>Excess Applied Date:</strong>
        <span>{{
          selectedPaymentDeposit.jsExcessAppliedDate | date: "MM/dd/yyyy"
        }}</span>
      </p>
    </p-card>

    <p class="mb-2 font-bold">Usage Details:</p>
    <p-table
      [value]="selectedPaymentDeposit.usageDetails || []"
      responsiveLayout="scroll"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Period</th>
          <th>Bill ID</th>
          <th>Allocated Principal</th>
          <th>Allocated Interest</th>
          <th>Allocated Fees</th>
          <th>Date</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-usage>
        <tr>
          <td>{{ usage.period }}</td>
          <td>{{ usage.billId }}</td>
          <td>{{ usage.allocatedPrincipal.toNumber() | currency }}</td>
          <td>{{ usage.allocatedInterest.toNumber() | currency }}</td>
          <td>{{ usage.allocatedFees.toNumber() | currency }}</td>
          <td>{{ usage.date.toDate() | date: "MM/dd/yyyy" }}</td>
        </tr>
      </ng-template>
    </p-table>
  </ng-container>
</p-dialog>
