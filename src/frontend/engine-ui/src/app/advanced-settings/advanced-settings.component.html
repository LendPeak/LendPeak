<!-- Toolbar -->
<p-toolbar class="p-mb-3">
  <!-- Left Group: Settings Management -->
  <div class="p-toolbar-group-left">
    <p-button
      label="New"
      icon="pi pi-file"
      class="p-button-secondary mr-3"
      (click)="startWithNewSettings()"
      pTooltip="Start with default advanced settings"
    ></p-button>
    <p-button
      label="Load"
      icon="pi pi-folder-open"
      class="p-button-primary mr-3"
      (click)="openLoadSettingsDialog()"
      pTooltip="Load saved advanced settings"
    ></p-button>
  </div>

  <!-- Center Group: Save Operation -->
  <div class="p-toolbar-group-center">
    <p-button
      label="Save"
      icon="pi pi-save"
      (click)="saveSettings()"
      [disabled]="!isModified"
      pTooltip="Save changes"
    ></p-button>
  </div>

  <!-- Right Group: Editing Tools -->
  <div class="p-toolbar-group-right">
    <p-button
      label="Reset"
      icon="pi pi-undo"
      class="p-button-warning mr-3"
      (click)="resetToOriginalSettings()"
      [disabled]="!isModified"
      pTooltip="Reset changes"
    ></p-button>
    <!-- Display Loaded Settings Info -->
    <span *ngIf="loadedSettingName" class="p-mr-2 loaded-settings">
      <i class="pi pi-cog"></i>
      {{ loadedSettingName }}
      <span *ngIf="loadedSettingVersion"> (v{{ loadedSettingVersion }}) </span>
    </span>
    <!-- Modified Indicator -->
    <span *ngIf="isModified" class="p-mr-2 modified-indicator">
      <i class="pi pi-info-circle"></i> Modified
    </span>
  </div>
</p-toolbar>

<!-- Accordion with Advanced Settings - Updated for PrimeNG 19+ -->
<p-accordion [multiple]="true">
  <!-- Term Configuration Section -->
  <p-accordion-panel value="termConfig">
    <p-accordion-header>Term Configuration</p-accordion-header>
    <p-accordion-content>
      <div class="p-fluid">
        <div class="field grid">
          <!-- Term Period Unit -->
          <div class="field col-6">
            <label for="termPeriodUnit">
              Term Period Unit
              <i
                class="pi pi-info-circle tooltip-icon"
                (click)="showTooltip($event, termPeriodUnitTooltip)"
              ></i>
            </label>
            <p-select
              inputId="termPeriodUnit"
              [(ngModel)]="loan.termPeriodDefinition.unit"
              [options]="termPeriodUnits"
              placeholder="Select a term period unit"
              (ngModelChange)="termPeriodDefinitionChange()"
              appendTo="body"
            ></p-select>
            <!-- Popover replacing OverlayPanel -->
            <p-popover #termPeriodUnitTooltip>
              <ng-template pTemplate="content">
                Defines the unit of time for each term period. For example,
                select "Month" for monthly payments.
              </ng-template>
            </p-popover>
          </div>

          <!-- Term Period Count -->
          <div class="field col-6">
            <label for="termPeriodCount">
              Term Period Count
              <i
                class="pi pi-info-circle tooltip-icon"
                (click)="showTooltip($event, termPeriodCountTooltip)"
              ></i>
            </label>
            <p-inputNumber
              inputId="termPeriodCount"
              [(ngModel)]="loan.termPeriodDefinition.count[0]"
              (ngModelChange)="termPeriodDefinitionChange()"
            ></p-inputNumber>
            <!-- Popover replacing OverlayPanel -->
            <p-popover #termPeriodCountTooltip>
              <ng-template pTemplate="content">
                Number of units per term period. For example, enter "1" for
                payments every 1 month.
              </ng-template>
            </p-popover>
          </div>

          <!-- Calendar Type -->
          <div class="field col-6">
            <label for="calendarType">
              Calendar Type
              <i
                class="pi pi-info-circle tooltip-icon"
                (click)="showTooltip($event, calendarTypeTooltip)"
              ></i>
            </label>
            <p-select
              inputId="calendarType"
              [(ngModel)]="loan.calendar.calendarType"
              [options]="calendarTypes"
              placeholder="Select a calendar type"
              (ngModelChange)="onInputChange()"
              appendTo="body"
            ></p-select>
            <!-- Popover replacing OverlayPanel -->
            <p-popover #calendarTypeTooltip>
              <ng-template pTemplate="content">
                <div class="tooltip-content">
                  <p>
                    Determines the calendar system used for the loan schedule...
                  </p>
                </div>
              </ng-template>
            </p-popover>
          </div>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>

  <!-- Payment Application Settings Section -->
  <p-accordion-panel value="paymentApp">
    <p-accordion-header>Payment Application Settings</p-accordion-header>
    <p-accordion-content>
      <div class="p-fluid">
        <!-- Allocation Strategy -->
        <div class="field">
          <label for="paymentAllocationStrategy">
            Payment Allocation Strategy
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, paymentAllocationStrategyTooltip)"
            ></i>
          </label>
          <p-select
            inputId="paymentAllocationStrategy"
            [(ngModel)]="paymentAllocationStrategyName"
            [options]="paymentAllocationStrategies"
            placeholder="Select an allocation strategy"
            (ngModelChange)="onInputChange()"
            appendTo="body"
          ></p-select>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #paymentAllocationStrategyTooltip>
            <ng-template pTemplate="content">
              <div class="tooltip-content">
                <p>Select the strategy for allocating deposits to bills...</p>
              </div>
            </ng-template>
          </p-popover>
        </div>

        <!-- Payment Priority -->
        <div class="field">
          <label for="paymentPriority">
            Payment Priority
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, paymentPriorityTooltip)"
            ></i>
          </label>
          <!-- Payment Priority Selection -->
          <div class="p-grid">
            <div class="p-col-4">
              <p-select
                inputId="paymentPriority"
                [(ngModel)]="paymentPriority[0]"
                [options]="paymentPriorityOptions"
                placeholder="First"
                (ngModelChange)="onPaymentPriorityChange()"
                appendTo="body"
              ></p-select>
            </div>
            <div class="p-col-4">
              <p-select
                [(ngModel)]="paymentPriority[1]"
                [options]="paymentPriorityOptions"
                placeholder="Second"
                (ngModelChange)="onPaymentPriorityChange()"
                appendTo="body"
              ></p-select>
            </div>
            <div class="p-col-4">
              <p-select
                [(ngModel)]="paymentPriority[2]"
                [options]="paymentPriorityOptions"
                placeholder="Third"
                (ngModelChange)="onPaymentPriorityChange()"
                appendTo="body"
              ></p-select>
            </div>
          </div>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #paymentPriorityTooltip>
            <ng-template pTemplate="content">
              <div class="tooltip-content">
                <p>
                  Specify the order in which payments are applied to
                  components...
                </p>
              </div>
            </ng-template>
          </p-popover>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>

  <!-- Billing Settings Section -->
  <p-accordion-panel value="billingSettings">
    <p-accordion-header>Billing Settings</p-accordion-header>
    <p-accordion-content>
      <div class="p-fluid">
        <!-- Loan Type Selection -->
        <div class="field">
          <label for="billingModel">
            Loan Type
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, billingModelTooltip)"
            ></i>
          </label>
          <p-select
            id="billingModel"
            [(ngModel)]="loan.billingModel"
            name="billingModel"
            [options]="billingModelOptions"
            placeholder="Select a loan type"
            (ngModelChange)="onInputChange()"
            appendTo="body"
          ></p-select>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #billingModelTooltip>
            <ng-template pTemplate="content">
              <div class="tooltip-content">
                <p>
                  <strong>Amortized Loan:</strong> An amortized loan has
                  scheduled payments applied to both principal and interest over
                  the life of the loan.
                </p>
                <p>
                  <strong>Daily Simple Interest Loan:</strong> A daily simple
                  interest loan accrues interest daily on the outstanding
                  principal.
                </p>
              </div>
            </ng-template>
          </p-popover>
        </div>

        <!-- Conditionally display these fields only for 'amortized' loans -->
        <div *ngIf="loan.billingModel === 'amortized'" class="field grid">
          <!-- Default Pre Bill Days -->
          <div class="field col-6">
            <label for="defaultPreBillDaysConfiguration">
              Default Pre Bill Days
              <i
                class="pi pi-info-circle tooltip-icon"
                (click)="showTooltip($event, defaultPreBillDaysTooltip)"
              ></i>
            </label>
            <p-inputNumber
              inputId="defaultPreBillDaysConfiguration"
              [(ngModel)]="loan.jsDefaultPreBillDaysConfiguration"
              (ngModelChange)="onInputChange()"
              appendTo="body"
            ></p-inputNumber>
            <!-- Popover replacing OverlayPanel -->
            <p-popover #defaultPreBillDaysTooltip>
              <ng-template pTemplate="content">
                Number of days before the period end to open the bill by
                default.
              </ng-template>
            </p-popover>
          </div>

          <!-- Default Due Date Days -->
          <div class="field col-6">
            <label for="defaultBillDueDaysAfterPeriodEndConfiguration">
              Default Due Date Days
              <i
                class="pi pi-info-circle tooltip-icon"
                (click)="showTooltip($event, defaultDueDateDaysTooltip)"
              ></i>
            </label>
            <p-inputNumber
              inputId="defaultBillDueDaysAfterPeriodEndConfiguration"
              [(ngModel)]="loan.jsDefaultBillDueDaysAfterPeriodEndConfiguration"
              (ngModelChange)="onInputChange()"
            ></p-inputNumber>
            <!-- Popover replacing OverlayPanel -->
            <p-popover #defaultDueDateDaysTooltip>
              <ng-template pTemplate="content">
                Number of days after the period end when the payment is due by
                default.
              </ng-template>
            </p-popover>
          </div>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>

  <!-- Interest Settings Section -->
  <p-accordion-panel value="interestSettings">
    <p-accordion-header>Interest Settings</p-accordion-header>
    <p-accordion-content>
      <div class="p-fluid">
        <!-- Per Diem Calculation Type -->
        <div class="field">
          <label for="perDiemCalculationType">
            Per Diem Calculation Type
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, perDiemCalculationTypeTooltip)"
            ></i>
          </label>
          <p-select
            id="perDiemCalculationType"
            [(ngModel)]="loan.perDiemCalculationType"
            name="perDiemCalculationType"
            [options]="perDiemCalculationTypes"
            placeholder="Select a per diem calculation type"
            (ngModelChange)="onInputChange()"
            appendTo="body"
          ></p-select>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #perDiemCalculationTypeTooltip>
            <ng-template pTemplate="content">
              <div class="tooltip-content">
                <p><strong>Per Diem Calculation Types:</strong></p>
                <ul>
                  <li>Annual Rate / Days in Year</li>
                  <li>Monthly Rate / Days in Month</li>
                </ul>
              </div>
            </ng-template>
          </p-popover>
        </div>

        <!-- Allow Rates Above 100% -->
        <div class="field-checkbox">
          <p-checkbox
            [(ngModel)]="loan.allowRateAbove100"
            name="allowRateAbove100"
            binary="true"
            (ngModelChange)="onInputChange()"
          ></p-checkbox>
          <label for="allowRateAbove100">
            Allow rates above 100%
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, allowRateAbove100Tooltip)"
            ></i>
          </label>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #allowRateAbove100Tooltip>
            <ng-template pTemplate="content">
              Enable this option to allow setting interest rates higher than
              100%.
            </ng-template>
          </p-popover>
        </div>

        <!-- Unbilled Interest Flush Method -->
        <div class="field">
          <label for="flushMethod">
            Unbilled Interest Flush Method
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, flushMethodTooltip)"
            ></i>
          </label>
          <p-select
            id="flushMethod"
            [(ngModel)]="loan.flushUnbilledInterestRoundingErrorMethod"
            name="flushMethod"
            [options]="flushMethods"
            placeholder="Select a flush method"
            (ngModelChange)="onInputChange()"
            appendTo="body"
          ></p-select>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #flushMethodTooltip>
            <ng-template pTemplate="content">
              Determines how unbilled interest is handled. Choose a method to
              define when unbilled interest should be flushed.
            </ng-template>
          </p-popover>
        </div>

        <!-- Flush Threshold -->
        <div
          class="field"
          *ngIf="loan.flushUnbilledInterestRoundingErrorMethod !== 'none'"
        >
          <label for="flushThreshold">
            Unbilled Interest Flush Threshold
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, flushThresholdTooltip)"
            ></i>
          </label>
          <p-inputNumber
            id="flushThreshold"
            [(ngModel)]="loan.flushThreshold"
            name="flushThreshold"
            mode="currency"
            currency="USD"
            locale="en-US"
            (ngModelChange)="onInputChange()"
          ></p-inputNumber>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #flushThresholdTooltip>
            <ng-template pTemplate="content">
              The threshold amount for flushing unbilled interest. For example,
              enter "$0.01" to flush unbilled interest when it reaches one cent.
            </ng-template>
          </p-popover>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>

  <!-- Rounding Settings Section -->
  <p-accordion-panel value="roundingSettings">
    <p-accordion-header>Rounding Settings</p-accordion-header>
    <p-accordion-content>
      <div class="p-fluid">
        <!-- Rounding Method -->
        <div class="field">
          <label for="roundingMethod">
            Rounding Method
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, roundingMethodTooltip)"
            ></i>
          </label>
          <p-select
            id="roundingMethod"
            [(ngModel)]="loan.roundingMethod"
            name="roundingMethod"
            [options]="roundingMethods"
            placeholder="Select a rounding method"
            (ngModelChange)="onInputChange()"
            appendTo="body"
          ></p-select>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #roundingMethodTooltip>
            <ng-template pTemplate="content">
              <div class="tooltip-content">
                <p>Specifies how to round calculated amounts...</p>
              </div>
            </ng-template>
          </p-popover>
        </div>

        <!-- Rounding Precision -->
        <div class="field">
          <label for="roundingPrecision">
            Rounding Precision (decimal places)
            <i
              class="pi pi-info-circle tooltip-icon"
              (click)="showTooltip($event, roundingPrecisionTooltip)"
            ></i>
          </label>
          <p-inputNumber
            id="roundingPrecision"
            [(ngModel)]="loan.roundingPrecision"
            name="roundingPrecision"
            (ngModelChange)="onInputChange()"
          ></p-inputNumber>
          <!-- Popover replacing OverlayPanel -->
          <p-popover #roundingPrecisionTooltip>
            <ng-template pTemplate="content">
              Number of decimal places to round to. For example, enter "2" to
              round amounts to two decimal places.
            </ng-template>
          </p-popover>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>
</p-accordion>

<!-- Save Settings Dialog -->
<p-dialog
  header="Save Advanced Settings"
  [(visible)]="showSaveSettingsDialog"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '400px' }"
>
  <div class="p-fluid">
    <div class="field">
      <label for="settingName">Setting Name</label>
      <input
        id="settingName"
        type="text"
        pInputText
        [(ngModel)]="newSetting.name"
      />
    </div>
    <div class="field-checkbox">
      <p-checkbox [(ngModel)]="newSetting.isDefault" binary="true"></p-checkbox>
      <label for="isDefault">Set as default</label>
    </div>
  </div>
  <div class="flex gap-2 mt-4 justify-content-end">
    <div class="p-d-flex p-jc-end">
      <p-button
        label="Cancel"
        class="p-mr-2"
        (onClick)="showSaveSettingsDialog = false"
      ></p-button>
      <p-button label="Save" (onClick)="confirmSaveSettings()"></p-button>
    </div>
  </div>
</p-dialog>

<!-- Load Settings Dialog -->
<p-dialog
  header="Load Advanced Settings"
  [(visible)]="showLoadSettingsDialog"
  [modal]="true"
  [style]="{ width: '600px' }"
  [closable]="true"
>
  <p-table
    [value]="savedSettings"
    selectionMode="single"
    [(selection)]="selectedSetting"
    [paginator]="true"
    [rows]="5"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Name</th>
        <th>Version</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-setting>
      <tr [pSelectableRow]="setting">
        <td>{{ setting.name }}</td>
        <td>{{ setting.version }}</td>
        <td>{{ setting.createdAt | date: "short" }}</td>
        <td>
          <div class="p-d-flex p-ai-center">
            <p-button
              icon="pi pi-eye"
              class="p-mr-2 pr-2"
              severity="info"
              (onClick)="previewSettings(setting)"
              pTooltip="Preview Settings"
            ></p-button>

            <p-button
              icon="pi pi-trash"
              severity="danger"
              (onClick)="deleteSetting(setting.id)"
              pTooltip="Delete Settings"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <div class="flex gap-2 mt-4 justify-content-end">
    <div class="p-d-flex p-jc-end">
      <p-button
        label="Cancel"
        class="p-mr-2 pr-2"
        (onClick)="showLoadSettingsDialog = false"
      ></p-button>
      <p-button
        label="Load"
        [disabled]="!selectedSetting"
        (onClick)="confirmLoadSettings()"
      ></p-button>
    </div>
  </div>
</p-dialog>

<!-- Preview Settings Dialog -->
<p-dialog
  header="Settings Preview"
  [(visible)]="showPreviewSettingsDialog"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '600px' }"
>
  <pre>{{ selectedSetting?.settings | json }}</pre>
  <div class="flex gap-2 mt-4 justify-content-end">
    <button
      pButton
      label="Close"
      (click)="showPreviewSettingsDialog = false"
    ></button>
  </div>
</p-dialog>
