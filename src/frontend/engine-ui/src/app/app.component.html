<p-toolbar>
  <div class="p-toolbar-group-start">
    <img src="horizontal-logo.png" style="width: 160px" />
  </div>
  <div class="p-toolbar-group-center"></div>

  <div class="p-toolbar-group-end">
    <p-button
      severity="success"
      label="Save UI"
      icon="pi pi-check"
      iconPos="right"
      class="mr-2"
      (onClick)="saveUIState()"
    />
    <p-button
      severity="danger"
      label="Reset UI"
      icon="pi pi-trash"
      iconPos="right"
      class="mr-2"
      (onClick)="resetUIState()"
    />
  </div>
</p-toolbar>

<form>
  <div class="grid">
    <div class="col-6">
      <div class="p-3 border-round-sm font-bold">
        <div class="grid">
          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <!-- Principal Amount -->
              <label for="principal">Principal Amount</label>
              <p-inputGroup>
                <p-inputGroupAddon>$</p-inputGroupAddon>
                <input
                  id="principal"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.principal"
                  name="principal"
                  placeholder="Enter principal amount"
                  (ngModelChange)="submitLoan()"
                />
              </p-inputGroup>
            </div>
          </div>

          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <!-- Origination Fee -->
              <label for="originationFee">Origination Fee</label>
              <p-inputGroup>
                <p-inputGroupAddon>$</p-inputGroupAddon>
                <input
                  id="originationFee"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.originationFee"
                  name="originationFee"
                  placeholder="Enter origination fee amount"
                  (ngModelChange)="submitLoan()"
                />
              </p-inputGroup>
            </div>
          </div>

          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <!-- Interest Rate (%) -->
              <label for="interestRate">Interest Rate (%)</label>
              <p-inputGroup>
                <p-inputGroupAddon>%</p-inputGroupAddon>
                <input
                  id="interestRate"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.interestRate"
                  name="interestRate"
                  placeholder="Enter interest rate"
                  (ngModelChange)="submitLoan()"
                />
              </p-inputGroup>
            </div>
          </div>

          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <!-- Term (Months) -->
              <label for="term"
                >Term ({{ amortization?.loanTermInMonths }} months)</label
              >
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar-times"></i>
                </p-inputGroupAddon>
                <input
                  id="term"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.term"
                  name="term"
                  placeholder="Enter loan term in months"
                  (ngModelChange)="updateTerm()"
                />
              </p-inputGroup>
            </div>
          </div>
          <!-- start of term period definition -->
          <div class="col-6">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>Term Period Unit</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <p-dropdown
                  [(ngModel)]="loan.termPeriodDefinition.unit"
                  name="termPeriodUnit"
                  id="termPeriodUnit"
                  [options]="termPeriodUnits"
                  placeholder="Select a term period unit"
                  (ngModelChange)="termPeriodDefinitionChange()"
                  styleClass="full-width"
                ></p-dropdown>
              </p-inputGroup>
            </div>
          </div>
          <div class="col-6">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>Term Period Count</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <input
                  id="termPeriodCount"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.termPeriodDefinition.count[0]"
                  name="termPeriodCount"
                  placeholder="Select a term period count"
                  (ngModelChange)="termPeriodDefinitionChange()"
                />
              </p-inputGroup>
            </div>
          </div>
          <!-- end of term period definition -->

          <div class="col-4">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>Start Date</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <p-calendar
                  [(ngModel)]="loan.startDate"
                  (ngModelChange)="updateStartDate()"
                  name="startDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                ></p-calendar>
              </p-inputGroup>
            </div>
          </div>
          <div class="col-4">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>First Payment Date</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <p-calendar
                  [(ngModel)]="loan.firstPaymentDate"
                  (ngModelChange)="submitLoan()"
                  name="firstPaymentDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                ></p-calendar>
              </p-inputGroup>
            </div>
          </div>
          <div class="col-4">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>End Date</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <p-calendar
                  [(ngModel)]="loan.endDate"
                  (ngModelChange)="submitLoan()"
                  name="endDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                ></p-calendar>
              </p-inputGroup>
            </div>
          </div>
          <!-- pre bill days config and due bill config -->
          <div class="col-6">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>Default Pre Bill Days</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <input
                  id="defaultPreBillDaysConfiguration"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.defaultPreBillDaysConfiguration"
                  name="defaultPreBillDaysConfiguration"
                  placeholder="Enter default pre bill days"
                  (ngModelChange)="submitLoan()"
                />
              </p-inputGroup>
            </div>
          </div>
          <div class="col-6">
            <div class="p-3 border-round-sm font-bold">
              <!-- Start Date -->
              <label>Default Due Date Days</label>
              <p-inputGroup>
                <p-inputGroupAddon>
                  <i class="pi pi-calendar"></i>
                </p-inputGroupAddon>
                <input
                  id="defaultBillDueDaysAfterPeriodEndConfiguration"
                  type="number"
                  pInputText
                  [(ngModel)]="
                    loan.defaultBillDueDaysAfterPeriodEndConfiguration
                  "
                  name="defaultBillDueDaysAfterPeriodEndConfiguration"
                  placeholder="Enter default due date days"
                  (ngModelChange)="submitLoan()"
                />
              </p-inputGroup>
            </div>
          </div>
          <!-- end of pre bill and due day configurations-->
        </div>
      </div>
    </div>

    <div class="col-6">
      <div class="p-3 border-round-sm font-bold">
        <div class="grid">
          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <!-- Interest Rate Overrides -->
              <p-fieldset
                legend="Interest Rate Override"
                [toggleable]="true"
                [(collapsed)]="rateOverrideCollapsed"
              >
                <table
                  *ngIf="loan.ratesSchedule.length > 0"
                  class="p-datatable p-component"
                >
                  <thead>
                    <tr>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Interest Rate (%)</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let rate of loan.ratesSchedule; let i = index">
                      <!-- Start Date -->
                      <td>
                        <p-calendar
                          [(ngModel)]="rate.startDate"
                          (ngModelChange)="submitLoan()"
                          name="overrideStartDate-{{ i }}"
                          dateFormat="mm/dd/yy"
                          showIcon
                        ></p-calendar>
                      </td>

                      <!-- End Date -->
                      <td>
                        <p-calendar
                          [(ngModel)]="rate.endDate"
                          (ngModelChange)="submitLoan()"
                          name="overrideEndDate-{{ i }}"
                          dateFormat="mm/dd/yy"
                          showIcon
                        ></p-calendar>
                      </td>

                      <!-- Interest Rate -->
                      <td>
                        <p-inputGroup>
                          <input
                            id="overrideInterestRate-{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="rate.annualInterestRate"
                            (ngModelChange)="submitLoan()"
                            name="overrideInterestRate-{{ i }}"
                            placeholder="Enter interest rate"
                          />
                          <p-inputGroupAddon> % </p-inputGroupAddon>
                        </p-inputGroup>
                      </td>

                      <!-- Remove Button -->
                      <td class="p-text-center">
                        <button
                          type="button"
                          pButton
                          icon="pi pi-minus"
                          class="p-button p-button-danger"
                          (click)="removeRateOverride(i)"
                        ></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div class="p-text-right p-mb-2">
                  <button
                    type="button"
                    pButton
                    icon="pi pi-plus"
                    label="Add New Rate Row"
                    class="p-button p-button-success"
                    (click)="addRateOverride()"
                  ></button>
                </div>
              </p-fieldset>
            </div>
          </div>

          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <p-fieldset
                legend="Term Payment Amount Override"
                [toggleable]="true"
                [(collapsed)]="termPaymentAmountOverrideCollapsed"
              >
                <table
                  *ngIf="loan.termPaymentAmountOverride.length > 0"
                  class="p-datatable p-component"
                >
                  <thead>
                    <tr>
                      <th>Term Number</th>
                      <th>Payment Amount</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="
                        let paymentConfiguration of loan.termPaymentAmountOverride;
                        let i = index
                      "
                    >
                      <!-- Term Number -->
                      <td>
                        <p-inputGroup>
                          <p-inputGroupAddon> # </p-inputGroupAddon>

                          <input
                            id="overrideTermPaymentTerm-{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="paymentConfiguration.termNumber"
                            name="overrideTermPayment-term{{ i }}"
                            placeholder="Enter Term Number"
                            (ngModelChange)="submitLoan()"
                          />
                        </p-inputGroup>
                      </td>

                      <!-- Payment Amount -->
                      <td>
                        <p-inputGroup>
                          <p-inputGroupAddon> $ </p-inputGroupAddon>

                          <input
                            id="overrideTermPaymentAmount-{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="paymentConfiguration.paymentAmount"
                            (ngModelChange)="submitLoan()"
                            name="overrideTermPaymentAmount-{{ i }}"
                            placeholder="Enter Payment Amount"
                          />
                        </p-inputGroup>
                      </td>

                      <!-- Remove Button -->
                      <td class="p-text-center">
                        <button
                          type="button"
                          pButton
                          icon="pi pi-minus"
                          class="p-button p-button-danger"
                          (click)="removeTermPaymentAmountOverride(i)"
                        ></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div class="p-text-right p-mb-2">
                  <button
                    type="button"
                    pButton
                    icon="pi pi-plus"
                    label="Add New Term Row"
                    class="p-button p-button-success"
                    (ngModelChange)="submitLoan()"
                    (click)="addTermPaymentAmountOverride()"
                  ></button>
                </div>
              </p-fieldset>
            </div>
          </div>

          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <p-fieldset
                legend="Change Payment Date"
                [toggleable]="true"
                [(collapsed)]="changePaymentDateCollapsed"
              >
                <table
                  *ngIf="loan.changePaymentDates.length > 0"
                  class="p-datatable p-component"
                >
                  <thead>
                    <tr>
                      <th>Term Number</th>
                      <th>New Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="
                        let changePaymentDate of loan.changePaymentDates;
                        let i = index
                      "
                    >
                      <td>
                        <div class="p-3 border-round-sm font-bold">
                          <p-inputGroup>
                            <p-inputGroupAddon> # </p-inputGroupAddon>

                            <input
                              id="changePaymentDate-term-{{ i }}"
                              type="number"
                              pInputText
                              [(ngModel)]="changePaymentDate.termNumber"
                              name="changePaymentDate-term{{ i }}"
                              placeholder="Enter Term Number"
                              (ngModelChange)="
                                updateTermForCPD(
                                  i,
                                  changePaymentDate.termNumber
                                )
                              "
                            />
                          </p-inputGroup>
                        </div>
                      </td>

                      <!-- End Date -->
                      <td>
                        <p-calendar
                          [(ngModel)]="changePaymentDate.newDate"
                          (ngModelChange)="submitLoan()"
                          name="changePaymentDateNewDate-{{ i }}"
                          dateFormat="mm/dd/yy"
                          showIcon
                        ></p-calendar>
                      </td>

                      <!-- Remove Button -->
                      <td class="p-text-center">
                        <button
                          type="button"
                          pButton
                          icon="pi pi-minus"
                          class="p-button p-button-danger"
                          (click)="removeChangePaymentDate(i)"
                        ></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div class="p-text-right p-mb-2">
                  <button
                    type="button"
                    pButton
                    icon="pi pi-plus"
                    label="Add Change Payment Date Row"
                    class="p-button p-button-success"
                    (ngModelChange)="submitLoan()"
                    (click)="addNewChangePaymentTermRow()"
                  ></button>
                </div>
              </p-fieldset>
            </div>
          </div>

          <!-- pre bill day configuration override -->
          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <p-fieldset
                legend="Pre Bill Day Term Override"
                [toggleable]="true"
                [(collapsed)]="preBillDayTermOverrideCollapsed"
              >
                <table
                  *ngIf="loan.preBillDays.length > 0"
                  class="p-datatable p-component"
                >
                  <thead>
                    <tr>
                      <th>Term Number</th>
                      <th>Days</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="let preBillDay of loan.preBillDays; let i = index"
                    >
                      <!-- Term Number -->
                      <td>
                        <p-inputGroup>
                          <p-inputGroupAddon> # </p-inputGroupAddon>

                          <input
                            id="preBillDayConfiguration-term{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="preBillDay.termNumber"
                            name="preBillDayConfiguration-term{{ i }}"
                            placeholder="Enter Term Number"
                            (ngModelChange)="submitLoan()"
                          />
                        </p-inputGroup>
                      </td>

                      <!-- Number of Days -->
                      <td>
                        <p-inputGroup>
                          <p-inputGroupAddon> # </p-inputGroupAddon>

                          <input
                            id="prebillDays-day-{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="preBillDay.preBillDays"
                            (ngModelChange)="submitLoan()"
                            name="prebillDays-day-{{ i }}"
                            placeholder="Enter Number Of Days"
                          />
                        </p-inputGroup>
                      </td>

                      <!-- Remove Button -->
                      <td class="p-text-center">
                        <button
                          type="button"
                          pButton
                          icon="pi pi-minus"
                          class="p-button p-button-danger"
                          (click)="removePreBillDayTerm(i)"
                        ></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div class="p-text-right p-mb-2">
                  <button
                    type="button"
                    pButton
                    icon="pi pi-plus"
                    label="Add New Term Row"
                    class="p-button p-button-success"
                    (ngModelChange)="submitLoan()"
                    (click)="addPrebillDayTermRow()"
                  ></button>
                </div>
              </p-fieldset>
            </div>
          </div>
          <!-- end of pre bill day configuration override -->

          <!-- due bill day configuration override -->
          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <p-fieldset
                legend="Due Bill Day Term Override"
                [toggleable]="true"
                [(collapsed)]="dueBillDayTermOverrideCollapsed"
              >
                <table
                  *ngIf="loan.dueBillDays.length > 0"
                  class="p-datatable p-component"
                >
                  <thead>
                    <tr>
                      <th>Term Number</th>
                      <th>Days</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="let dueBillDay of loan.dueBillDays; let i = index"
                    >
                      <!-- Term Number -->
                      <td>
                        <p-inputGroup>
                          <p-inputGroupAddon> # </p-inputGroupAddon>

                          <input
                            id="dueBillDayConfiguration-term{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="dueBillDay.termNumber"
                            name="dueBillDayConfiguration-term{{ i }}"
                            placeholder="Enter Term Number"
                            (ngModelChange)="submitLoan()"
                          />
                        </p-inputGroup>
                      </td>

                      <!-- Number of Days -->
                      <td>
                        <p-inputGroup>
                          <p-inputGroupAddon> # </p-inputGroupAddon>

                          <input
                            id="duebillDays-day-{{ i }}"
                            type="number"
                            pInputText
                            [(ngModel)]="dueBillDay.daysDueAfterPeriodEnd"
                            (ngModelChange)="submitLoan()"
                            name="duebillDays-day-{{ i }}"
                            placeholder="Enter Number Of Days"
                          />
                        </p-inputGroup>
                      </td>

                      <!-- Remove Button -->
                      <td class="p-text-center">
                        <button
                          type="button"
                          pButton
                          icon="pi pi-minus"
                          class="p-button p-button-danger"
                          (click)="removeDueBillDayTerm(i)"
                        ></button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div class="p-text-right p-mb-2">
                  <button
                    type="button"
                    pButton
                    icon="pi pi-plus"
                    label="Add New Term Row"
                    class="p-button p-button-success"
                    (ngModelChange)="submitLoan()"
                    (click)="addDueBillDayTermRow()"
                  ></button>
                </div>
              </p-fieldset>
            </div>
          </div>
          <!-- end of due bill day configuration override -->

          <div class="col-12">
            <div class="p-3 border-round-sm font-bold">
              <p-fieldset
                legend="Advanced Settings"
                [toggleable]="true"
                [(collapsed)]="advancedSettingsCollapsed"
              >
                <!-- Term Payment Amount-->
                <div class="formgrid grid">
                  <div class="field col">
                    <label for="termPaymentAmount">Term Payment Amount</label>
                    <p-inputGroup>
                      <p-inputGroupAddon>$</p-inputGroupAddon>
                      <input
                        id="termPaymentAmount"
                        type="number"
                        pInputText
                        [(ngModel)]="loan.termPaymentAmount"
                        name="termPaymentAmount"
                        placeholder="Enter Term Payment Amount"
                        (ngModelChange)="onTermPaymentAmountChange($event)"
                      />
                    </p-inputGroup>
                  </div>
                </div>

                <!-- Calendar Type -->
                <div class="formgrid grid">
                  <div class="field col">
                    <label>Calendar Type</label>
                    <p-dropdown
                      [(ngModel)]="loan.calendarType"
                      name="calendarType"
                      id="calendarType"
                      [options]="calendarTypes"
                      placeholder="Select a calendar type"
                      (ngModelChange)="submitLoan()"
                      styleClass="full-width"
                    ></p-dropdown>
                  </div>
                </div>

                <p-card>
                  <div class="formgrid grid">
                    <div class="field-checkbox col">
                      <p-checkbox
                        [(ngModel)]="loan.allowRateAbove100"
                        name="allowRateAbove100"
                        id="allowRateAbove100"
                        [binary]="true"
                        (ngModelChange)="submitLoan()"
                      ></p-checkbox>
                      <label>Allow rates above 100%</label>
                    </div>
                  </div>
                </p-card>

                <p-divider />

                <p-card>
                  <!-- Rounding Method -->
                  <div class="formgrid grid">
                    <div class="field col">
                      <label>Rounding Method</label>
                      <p-dropdown
                        [(ngModel)]="loan.roundingMethod"
                        name="roundingMethod"
                        id="roundingMethod"
                        [options]="roundingMethods"
                        placeholder="Select a rounding method"
                        (ngModelChange)="submitLoan()"
                      ></p-dropdown>
                    </div>
                  </div>

                  <!-- Rounding Precision -->
                  <div class="formgrid grid">
                    <div class="field col">
                      <!-- Rounding Precision -->
                      <label for="roundingPrecision"
                        >Rounding Precision (decimal places)</label
                      >
                      <p-inputGroup>
                        <p-inputGroupAddon>#</p-inputGroupAddon>
                        <input
                          id="roundingPrecision"
                          type="number"
                          pInputText
                          [(ngModel)]="loan.roundingPrecision"
                          name="roundingPrecision"
                          placeholder="Enter rounding precision"
                          (ngModelChange)="submitLoan()"
                        />
                      </p-inputGroup>
                    </div>
                  </div>
                </p-card>
                <p-divider />
                <p-card>
                  <div class="formgrid grid">
                    <div class="field col">
                      <label>Unbilled Interest Flush Method</label>
                      <p-dropdown
                        [(ngModel)]="loan.flushMethod"
                        name="flushMethod"
                        id="flushMethod"
                        [options]="flushMethods"
                        placeholder="Select a flush method"
                        (ngModelChange)="submitLoan()"
                      ></p-dropdown>
                    </div>
                  </div>

                  <!-- Flush Threshold (only if flush method is not 'none') -->
                  <div class="formgrid grid">
                    <div class="field col">
                      <label for="flushThreshold"
                        >Unbilled Interest Flush Threshold</label
                      >
                      <p-inputGroup>
                        <p-inputGroupAddon>$</p-inputGroupAddon>
                        <input
                          id="flushThreshold"
                          type="number"
                          pInputText
                          [(ngModel)]="loan.flushThreshold"
                          name="flushThreshold"
                          placeholder="Enter flush threshold"
                          (ngModelChange)="submitLoan()"
                        />
                      </p-inputGroup>
                    </div>
                  </div>
                </p-card>
              </p-fieldset>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="p-3 border-round-sm font-bold">
        <p-fieldset
          legend="Custom Periods Schedule"
          [toggleable]="true"
          [(collapsed)]="customPeriodsScheduleCollapsed"
        >
          <div class="grid">
            <div class="col-fixed" style="width: 18em">
              <p-button
                label="Create Custom Schedule"
                icon="pi pi-plus"
                (onClick)="createLoanRepaymentPlan()"
              ></p-button>
            </div>
            <div class="col-fixed" style="width: 18em">
              <p-button
                label="Remove Schedule Override"
                icon="pi pi-minus"
                (onClick)="removeLoanRepaymentPlan()"
                class="p-button-danger"
              ></p-button>
            </div>
          </div>
          <div class="p-mb-3"></div>
          <p-divider />
          <table
            *ngIf="loan.periodsSchedule.length > 0"
            class="p-datatable p-component"
          >
            <thead>
              <tr>
                <th>Term</th>
                <th>Start Date</th>
                <th>End Date</th>
                <!-- <th>Payment Amount</th>
                <th>Interest Rate</th> -->
                <!-- <th>Actions</th> -->
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let plan of loan.periodsSchedule; let i = index">
                <td>{{ i + 1 }}</td>
                <td>
                  <p-calendar
                    [(ngModel)]="plan.startDate"
                    (ngModelChange)="submitLoan()"
                    dateFormat="mm/dd/yy"
                    name="periodStartDate-{{ i }}"
                    showIcon
                  ></p-calendar>
                </td>
                <td>
                  <p-calendar
                    [(ngModel)]="plan.endDate"
                    (ngModelChange)="repaymentPlanEndDateChange(i)"
                    dateFormat="mm/dd/yy"
                    name="periodEndDate-{{ i }}"
                    showIcon
                  ></p-calendar>
                </td>
                <!-- <td>
                  <input
                    type="number"
                    pInputText
                    [(ngModel)]="plan.paymentAmount"
                    name="periodPaymentAmount-{{ i }}"
                    (ngModelChange)="submitLoan()"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    pInputText
                    [(ngModel)]="plan.interestRate"
                    name="periodRate-{{ i }}"
                    (ngModelChange)="submitLoan()"
                  />
                </td> -->
                <!-- <td>
                  <p-button
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-danger p-mr-2"
                    (onClick)="deletePlan(i)"
                  ></p-button>

                  <p-button
                    icon="pi pi-chevron-up"
                    class="p-button-rounded p-button-danger p-ml-2"
                    (onClick)="addRowToPlanAbove(i)"
                  ></p-button>
                </td> -->
              </tr>
            </tbody>
          </table>
        </p-fieldset>
      </div>
    </div>

    <!-- start balance modifications -->
    <div class="col-12">
      <div class="p-3 border-round-sm font-bold">
        <p-fieldset
          legend="Balance Modifications"
          [toggleable]="true"
          [(collapsed)]="balanceModificationsCollapsed"
        >
          <div class="p-mb-3"></div>
          <p-divider />
          <table
            *ngIf="loan.balanceModifications.length > 0"
            class="p-datatable p-component"
          >
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <!-- <th>Payment Amount</th>
                <th>Interest Rate</th> -->
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="
                  let balanceModification of loan.balanceModifications;
                  let i = index
                "
              >
                <td>
                  <p-calendar
                    [(ngModel)]="balanceModification.date"
                    (ngModelChange)="submitLoan()"
                    dateFormat="mm/dd/yy"
                    name="balanceModificationDate-{{ i }}"
                    showIcon
                  ></p-calendar>
                </td>
                <td>
                  <p-dropdown
                    [(ngModel)]="balanceModification.type"
                    name="balanceModificationType={{ i }}"
                    id="balanceModificationType={{ i }}"
                    [options]="balanceIncreaseType"
                    placeholder="Select a balance increase type"
                    (ngModelChange)="submitLoan()"
                    styleClass="full-width"
                  ></p-dropdown>
                </td>
                <td>
                  <input
                    type="number"
                    pInputText
                    [(ngModel)]="balanceModification.amount"
                    name="balanceModificationAmount-{{ i }}"
                    (ngModelChange)="submitLoan()"
                  />
                </td>
                <!--
                <td>
                  <input
                    type="number"
                    pInputText
                    [(ngModel)]="plan.interestRate"
                    name="periodRate-{{ i }}"
                    (ngModelChange)="submitLoan()"
                  />
                </td> -->
                <td>
                  <p-button
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-danger p-mr-2"
                    (onClick)="deleteBalanceModificationRow(i)"
                  ></p-button>
                </td>
              </tr>
            </tbody>
          </table>

          <p-divider />

          <div class="grid">
            <div class="col-fixed">
              <p-button
                label="Add Balance Modification Row"
                icon="pi pi-plus"
                (onClick)="addBalanceModificationRow()"
              ></p-button>
            </div>
          </div>
        </p-fieldset>
      </div>
    </div>
    <!-- end balance modifications -->

    <!-- add payments -->

    <!-- end of add payments-->
  </div>
</form>

<!-- end of form -->
<p-divider />

<p-card>
  <p-button
    (onClick)="showTilaDialogButton()"
    label="Truth in Lending Disclosure Statement"
  />
  <p-dialog
    header="Truth in Lending Disclosure Statement"
    [modal]="true"
    [(visible)]="showTilaDialog"
    [style]="{ width: '90%' }"
  >
    <app-tila-disclosure
      [showTitle]="false"
      [tilaDisclosures]="tilaDisclosures"
      [lenderName]="lenderName"
      [borrowerName]="borrowerName"
      [loanDate]="loanDate"
      [loanNumber]="loanNumber"
      [collateralDescription]="collateralDescription"
      [prepaymentPenalty]="prepaymentPenalty"
      [latePaymentGracePeriod]="latePaymentGracePeriod"
      [latePaymentFee]="latePaymentFee"
      [assumable]="assumable"
    ></app-tila-disclosure>
  </p-dialog>
</p-card>
<p-divider />

<!-- start of table-->
<!-- Repayment Plan Table -->
<div *ngIf="showTable" class="p-mt-4">
  <!-- Repayment Plan Card -->
  <p-card header="Repayment Plan" class="p-mt-3">
    <p-card>
      <div class="grid">
        <div class="col">
          <div class="text-center p-1 border-round-sm font-bold">
            <p-tag
              severity="success"
              value="Term In Months: {{ amortization?.loanTermInMonths }}"
            />
          </div>
        </div>
        <div class="col">
          <div class="text-center p-1 border-round-sm font-bold">
            <p-tag
              severity="success"
              value="APR: {{ amortization?.apr?.toDecimalPlaces(4) }}%"
            />
          </div>
        </div>
        <div class="col">
          <div class="text-center p-1 border-round-sm font-bold">
            <p-tag
              severity="success"
              value="Total Charged Interest: ${{
                amortization?.totalChargedInterestRounded?.toNumber()
              }}"
            />
          </div>
        </div>
      </div>
    </p-card>
    <p-divider />
    <!-- Table Toggle Button -->
    <div class="p-text-center p-mt-3">
      <p-button
        label="Show {{ showAdvancedTable ? 'Simple' : 'Advanced' }} Table"
        icon="pi pi-table"
        (onClick)="toggleAdvancedTable()"
      ></p-button>
    </div>
    <p-divider />
    <p-table [value]="repaymentPlan">
      <ng-template pTemplate="header">
        <tr>
          <th>Period</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Bill Open Date</th>
          <th>Bill Due Date</th>
          <th>Interest Rate</th>
          <th>Total Interest</th>
          <th>Principal</th>
          <th>Total Payment</th>
          <th>End Balance</th>
          <!-- Advanced Columns -->
          <th *ngIf="showAdvancedTable">Start Balance</th>
          <th *ngIf="showAdvancedTable">Balance Modification Amount</th>
          <th *ngIf="showAdvancedTable">Interest</th>
          <th *ngIf="showAdvancedTable">Billed Deferred Interest</th>
          <th *ngIf="showAdvancedTable">Real Interest</th>
          <th *ngIf="showAdvancedTable">Rounding Error</th>
          <th *ngIf="showAdvancedTable">Per Diem</th>
          <th *ngIf="showAdvancedTable">Days</th>
          <th *ngIf="showAdvancedTable">Start Balance</th>
          <th *ngIf="showAdvancedTable">End Balance</th>
          <th *ngIf="showAdvancedTable">Unbilled Interest</th>
          <th *ngIf="showAdvancedTable">Total Deferred Interest</th>
          <th *ngIf="showAdvancedTable">
            Deferred Interest For Current Period
          </th>
          <th *ngIf="showAdvancedTable">Pre Bill Days</th>
          <th *ngIf="showAdvancedTable">Due Day Days</th>
          <th *ngIf="showAdvancedTable">Metadata</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-plan>
        <tr>
          <td>{{ plan.period }}</td>
          <td>{{ plan.periodStartDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodEndDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodBillOpenDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodBillDueDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodInterestRate }}%</td>
          <td>{{ plan.totalInterestForPeriod | currency }}</td>
          <td>{{ plan.principal | currency }}</td>
          <td>{{ plan.totalPayment | currency }}</td>
          <td>{{ plan.endBalance | currency }}</td>
          <!-- Advanced Columns -->
          <td *ngIf="showAdvancedTable">
            {{ plan.startBalance | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.balanceModificationAmount | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.interest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.billedDeferredInterest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.realInterest }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.interestRoundingError }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.perDiem | currency }}
          </td>
          <td *ngIf="showAdvancedTable">{{ plan.daysInPeriod }}</td>
          <td *ngIf="showAdvancedTable">
            {{ plan.startBalance | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.endBalance | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.unbilledInterestDueToRounding }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.totalDeferredInterest }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.deferredInterestFromCurrentPeriod }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.prebillDaysConfiguration }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.billDueDaysAfterPeriodEndConfiguration }}
          </td>
          <td *ngIf="showAdvancedTable">
            <table class="metadata-table">
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of plan.metadata | keyvalue">
                  <td>{{ item.key }}</td>
                  <td>{{ item.value }}</td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
<!-- end of table-->
