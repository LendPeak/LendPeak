<!-- Toolbar -->
<p-toolbar>
  <div class="p-toolbar-group-start">
    <img src="horizontal-logo.png" style="width: 160px" />
  </div>
  <div class="p-toolbar-group-end">
    <p-button
      severity="success"
      label="Save UI"
      icon="pi pi-check"
      iconPos="right"
      class="mr-2"
      (onClick)="saveUIState()"
    ></p-button>
    <p-button
      severity="danger"
      label="Reset UI"
      icon="pi pi-trash"
      iconPos="right"
      class="mr-2"
      (onClick)="resetUIState()"
    ></p-button>
  </div>
</p-toolbar>

<!-- TabView -->
<p-tabView>
  <!-- Basic Loan Info Tab -->
  <p-tabPanel header="Basic Loan Info">
    <form>
      <div class="grid">
        <div class="col-12">
          <p-card header="Loan Details">
            <div class="grid p-fluid">
              <!-- Principal Amount -->
              <div class="field col-6">
                <label for="principal">Principal Amount</label>
                <p-inputNumber
                  id="principal"
                  [(ngModel)]="loan.principal"
                  name="principal"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="submitLoan()"
                  pTooltip="The initial amount of the loan. E.g., $100,000"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>

              <!-- Origination Fee -->
              <div class="field col-6">
                <label for="originationFee">Origination Fee</label>
                <p-inputNumber
                  id="originationFee"
                  [(ngModel)]="loan.originationFee"
                  name="originationFee"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="submitLoan()"
                  pTooltip="The fee charged by the lender for processing the loan. E.g., $1,000"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>

              <!-- Interest Rate (%) -->
              <div class="field col-6">
                <label for="interestRate">Interest Rate (%)</label>
                <p-inputNumber
                  id="interestRate"
                  [(ngModel)]="loan.interestRate"
                  name="interestRate"
                  mode="decimal"
                  minFractionDigits="2"
                  suffix="%"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Annual interest rate for the loan. E.g., 5%"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>

              <!-- Term (Months) -->
              <div class="field col-6">
                <label for="term"
                  >Term ({{ amortization?.loanTermInMonths }} months)</label
                >
                <p-inputNumber
                  id="term"
                  [(ngModel)]="loan.term"
                  name="term"
                  (ngModelChange)="updateTerm()"
                  pTooltip="Number of periods for the loan term. E.g., 12"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>

              <!-- Start Date -->
              <div class="field col-4">
                <label for="startDate">Start Date</label>
                <p-calendar
                  id="startDate"
                  [(ngModel)]="loan.startDate"
                  name="startDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                  (onSelect)="updateStartDate()"
                  pTooltip="The date when the loan starts. E.g., 01/01/2024"
                  tooltipPosition="top"
                ></p-calendar>
              </div>

              <!-- First Payment Date -->
              <div class="field col-4">
                <label for="firstPaymentDate">First Payment Date</label>
                <p-calendar
                  id="firstPaymentDate"
                  [(ngModel)]="loan.firstPaymentDate"
                  name="firstPaymentDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                  (onSelect)="submitLoan()"
                  pTooltip="The date of the first payment. E.g., 02/01/2024"
                  tooltipPosition="top"
                ></p-calendar>
              </div>

              <!-- End Date -->
              <div class="field col-4">
                <label for="endDate">End Date</label>
                <p-calendar
                  id="endDate"
                  [(ngModel)]="loan.endDate"
                  name="endDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                  (onSelect)="submitLoan()"
                  pTooltip="The date when the loan ends. Calculated automatically if not set."
                  tooltipPosition="top"
                ></p-calendar>
              </div>
            </div>
          </p-card>
        </div>
      </div>
    </form>
  </p-tabPanel>

  <!-- Overrides Tab -->
  <p-tabPanel header="Overrides">
    <div class="grid">
      <div class="col-12">
        <p-accordion multiple="true">
          <!-- Interest Rate Overrides -->
          <p-accordionTab header="Interest Rate Override">
            <div class="p-fluid">
              <table
                *ngIf="loan.ratesSchedule.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Interest Rate (%)</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let rate of loan.ratesSchedule; let i = index">
                    <!-- Start Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="rate.startDate"
                        name="overrideStartDate-{{ i }}"
                        dateFormat="mm/dd/yy"
                        showIcon
                        (onSelect)="submitLoan()"
                        pTooltip="Override start date for the interest rate."
                        tooltipPosition="top"
                      ></p-calendar>
                    </td>
                    <!-- End Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="rate.endDate"
                        name="overrideEndDate-{{ i }}"
                        dateFormat="mm/dd/yy"
                        showIcon
                        (onSelect)="submitLoan()"
                        pTooltip="Override end date for the interest rate."
                        tooltipPosition="top"
                      ></p-calendar>
                    </td>
                    <!-- Interest Rate -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="rate.annualInterestRate"
                        name="overrideInterestRate-{{ i }}"
                        mode="decimal"
                        minFractionDigits="2"
                        suffix="%"
                        (ngModelChange)="submitLoan()"
                        pTooltip="Override annual interest rate. E.g., 6%"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeRateOverride(i)"
                        pTooltip="Remove this override."
                        tooltipPosition="top"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Rate Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addRateOverride()"
                  pTooltip="Add a new interest rate override."
                  tooltipPosition="top"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Term Payment Amount Override -->
          <p-accordionTab header="Term Payment Amount Override">
            <div class="p-fluid">
              <table
                *ngIf="loan.termPaymentAmountOverride.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Payment Amount</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let paymentConfiguration of loan.termPaymentAmountOverride;
                      let i = index
                    "
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="paymentConfiguration.termNumber"
                        name="overrideTermPayment-term{{ i }}"
                        (ngModelChange)="submitLoan()"
                        pTooltip="The term number to override. E.g., 1"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Payment Amount -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="paymentConfiguration.paymentAmount"
                        name="overrideTermPaymentAmount-{{ i }}"
                        mode="currency"
                        currency="USD"
                        locale="en-US"
                        (ngModelChange)="submitLoan()"
                        pTooltip="Override payment amount for this term. E.g., $1,000"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeTermPaymentAmountOverride(i)"
                        pTooltip="Remove this override."
                        tooltipPosition="top"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Term Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addTermPaymentAmountOverride()"
                  pTooltip="Add a new term payment amount override."
                  tooltipPosition="top"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Change Payment Date -->
          <p-accordionTab header="Change Payment Date">
            <div class="p-fluid">
              <table
                *ngIf="loan.changePaymentDates.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>New Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let changePaymentDate of loan.changePaymentDates;
                      let i = index
                    "
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="changePaymentDate.termNumber"
                        name="changePaymentDate-term{{ i }}"
                        (ngModelChange)="
                          updateTermForCPD(i, changePaymentDate.termNumber)
                        "
                        pTooltip="The term number to change the payment date for. E.g., 1"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- New Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="changePaymentDate.newDate"
                        name="changePaymentDateNewDate-{{ i }}"
                        dateFormat="mm/dd/yy"
                        showIcon
                        (onSelect)="submitLoan()"
                        pTooltip="The new payment date for this term."
                        tooltipPosition="top"
                      ></p-calendar>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeChangePaymentDate(i)"
                        pTooltip="Remove this change."
                        tooltipPosition="top"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add Change Payment Date Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addNewChangePaymentTermRow()"
                  pTooltip="Add a new change payment date row."
                  tooltipPosition="top"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Pre Bill Day Term Override -->
          <p-accordionTab header="Pre Bill Day Term Override">
            <div class="p-fluid">
              <table
                *ngIf="loan.preBillDays.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Days</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let preBillDay of loan.preBillDays; let i = index"
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="preBillDay.termNumber"
                        name="preBillDayConfiguration-term{{ i }}"
                        (ngModelChange)="submitLoan()"
                        pTooltip="The term number to override pre-bill days for. E.g., 1"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Days -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="preBillDay.preBillDays"
                        name="prebillDays-day-{{ i }}"
                        (ngModelChange)="submitLoan()"
                        pTooltip="Number of days before the period end to open the bill. E.g., 5"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removePreBillDayTerm(i)"
                        pTooltip="Remove this override."
                        tooltipPosition="top"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Term Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addPrebillDayTermRow()"
                  pTooltip="Add a new pre-bill day term override."
                  tooltipPosition="top"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Due Bill Day Term Override -->
          <p-accordionTab header="Due Bill Day Term Override">
            <div class="p-fluid">
              <table
                *ngIf="loan.dueBillDays.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Days</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let dueBillDay of loan.dueBillDays; let i = index"
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="dueBillDay.termNumber"
                        name="dueBillDayConfiguration-term{{ i }}"
                        (ngModelChange)="submitLoan()"
                        pTooltip="The term number to override due bill days for. E.g., 1"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Days -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="dueBillDay.daysDueAfterPeriodEnd"
                        name="duebillDays-day-{{ i }}"
                        (ngModelChange)="submitLoan()"
                        pTooltip="Number of days after the period end when the payment is due. E.g., 30"
                        tooltipPosition="top"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeDueBillDayTerm(i)"
                        pTooltip="Remove this override."
                        tooltipPosition="top"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Term Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addDueBillDayTermRow()"
                  pTooltip="Add a new due bill day term override."
                  tooltipPosition="top"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>
        </p-accordion>
      </div>
    </div>
  </p-tabPanel>

  <!-- Advanced Settings Tab -->
  <p-tabPanel header="Advanced Settings">
    <div class="grid">
      <div class="col-12">
        <p-card header="Advanced Settings">
          <div class="p-fluid">
            <!-- Term Configuration Section -->
            <p-fieldset legend="Term Configuration">
              <div class="grid">
                <!-- Term Period Unit -->
                <div class="field col-6">
                  <label for="termPeriodUnit">Term Period Unit</label>
                  <p-dropdown
                    id="termPeriodUnit"
                    [(ngModel)]="loan.termPeriodDefinition.unit"
                    name="termPeriodUnit"
                    [options]="termPeriodUnits"
                    placeholder="Select a term period unit"
                    (ngModelChange)="termPeriodDefinitionChange()"
                    pTooltip="Defines the unit of time for each term period. E.g., 'Month'"
                    tooltipPosition="top"
                  ></p-dropdown>
                </div>

                <!-- Term Period Count -->
                <div class="field col-6">
                  <label for="termPeriodCount">Term Period Count</label>
                  <p-inputNumber
                    id="termPeriodCount"
                    [(ngModel)]="loan.termPeriodDefinition.count[0]"
                    name="termPeriodCount"
                    (ngModelChange)="termPeriodDefinitionChange()"
                    pTooltip="Number of units per term period. E.g., '1' for monthly payments"
                    tooltipPosition="top"
                  ></p-inputNumber>
                </div>

                <!-- Calendar Type -->
                <div class="field col-6">
                  <label for="calendarType">Calendar Type</label>
                  <p-dropdown
                    id="calendarType"
                    [(ngModel)]="loan.calendarType"
                    name="calendarType"
                    [options]="calendarTypes"
                    placeholder="Select a calendar type"
                    (ngModelChange)="submitLoan()"
                    pTooltip="Determines the calendar system used for the loan schedule."
                    tooltipPosition="top"
                  ></p-dropdown>
                </div>
              </div>
            </p-fieldset>

            <!-- Payment Settings Section -->
            <p-fieldset legend="Payment Settings">
              <!-- Term Payment Amount -->
              <div class="field">
                <label for="termPaymentAmount">Term Payment Amount</label>
                <p-inputNumber
                  id="termPaymentAmount"
                  [(ngModel)]="loan.termPaymentAmount"
                  name="termPaymentAmount"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="onTermPaymentAmountChange($event)"
                  pTooltip="Override the calculated payment amount per term. E.g., $1,200"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>
            </p-fieldset>

            <!-- Billing Settings Section -->
            <p-fieldset legend="Billing Settings">
              <!-- Default Pre Bill Days -->
              <div class="field col-6">
                <label for="defaultPreBillDaysConfiguration"
                  >Default Pre Bill Days</label
                >
                <p-inputNumber
                  id="defaultPreBillDaysConfiguration"
                  [(ngModel)]="loan.defaultPreBillDaysConfiguration"
                  name="defaultPreBillDaysConfiguration"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Number of days before the period end to open the bill by default. E.g., 5"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>

              <!-- Default Due Date Days -->
              <div class="field col-6">
                <label for="defaultBillDueDaysAfterPeriodEndConfiguration"
                  >Default Due Date Days</label
                >
                <p-inputNumber
                  id="defaultBillDueDaysAfterPeriodEndConfiguration"
                  [(ngModel)]="
                    loan.defaultBillDueDaysAfterPeriodEndConfiguration
                  "
                  name="defaultBillDueDaysAfterPeriodEndConfiguration"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Number of days after the period end when the payment is due by default. E.g., 30"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>
            </p-fieldset>

            <!-- Interest Settings Section -->
            <p-fieldset legend="Interest Settings">
              <!-- Allow Rates Above 100% -->
              <div class="field-checkbox">
                <p-checkbox
                  [(ngModel)]="loan.allowRateAbove100"
                  name="allowRateAbove100"
                  binary="true"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Allow setting interest rates above 100%."
                  tooltipPosition="top"
                ></p-checkbox>
                <label for="allowRateAbove100">Allow rates above 100%</label>
              </div>

              <!-- Unbilled Interest Flush Method -->
              <div class="field">
                <label for="flushMethod">Unbilled Interest Flush Method</label>
                <p-dropdown
                  id="flushMethod"
                  [(ngModel)]="loan.flushMethod"
                  name="flushMethod"
                  [options]="flushMethods"
                  placeholder="Select a flush method"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Determines how unbilled interest is handled."
                  tooltipPosition="top"
                ></p-dropdown>
              </div>

              <!-- Flush Threshold -->
              <div class="field" *ngIf="loan.flushMethod !== 'none'">
                <label for="flushThreshold"
                  >Unbilled Interest Flush Threshold</label
                >
                <p-inputNumber
                  id="flushThreshold"
                  [(ngModel)]="loan.flushThreshold"
                  name="flushThreshold"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="submitLoan()"
                  pTooltip="The threshold amount for flushing unbilled interest. E.g., $0.01"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>
            </p-fieldset>

            <!-- Rounding Settings Section -->
            <p-fieldset legend="Rounding Settings">
              <!-- Rounding Method -->
              <div class="field">
                <label for="roundingMethod">Rounding Method</label>
                <p-dropdown
                  id="roundingMethod"
                  [(ngModel)]="loan.roundingMethod"
                  name="roundingMethod"
                  [options]="roundingMethods"
                  placeholder="Select a rounding method"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Specifies how to round calculated amounts."
                  tooltipPosition="top"
                ></p-dropdown>
              </div>

              <!-- Rounding Precision -->
              <div class="field">
                <label for="roundingPrecision"
                  >Rounding Precision (decimal places)</label
                >
                <p-inputNumber
                  id="roundingPrecision"
                  [(ngModel)]="loan.roundingPrecision"
                  name="roundingPrecision"
                  (ngModelChange)="submitLoan()"
                  pTooltip="Number of decimal places to round to. E.g., 2"
                  tooltipPosition="top"
                ></p-inputNumber>
              </div>
            </p-fieldset>
          </div>
        </p-card>
      </div>
    </div>
  </p-tabPanel>

  <!-- Custom Periods Schedule Tab -->
  <p-tabPanel header="Custom Periods Schedule">
    <div class="grid">
      <div class="col-12">
        <p-card>
          <div class="p-mb-3">
            <p-button
              label="Create Custom Schedule"
              icon="pi pi-plus"
              class="p-button-success"
              (onClick)="createLoanRepaymentPlan()"
              pTooltip="Generate a custom periods schedule based on your inputs."
              tooltipPosition="top"
            ></p-button>
            <p-button
              label="Remove Schedule Override"
              icon="pi pi-minus"
              class="p-button-danger p-ml-2"
              (onClick)="removeLoanRepaymentPlan()"
              pTooltip="Remove the custom periods schedule override."
              tooltipPosition="top"
            ></p-button>
          </div>
          <p-divider></p-divider>
          <div class="p-fluid">
            <table
              *ngIf="loan.periodsSchedule.length > 0"
              class="p-datatable p-component"
            >
              <thead>
                <tr>
                  <th>Term</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let plan of loan.periodsSchedule; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <p-calendar
                      [(ngModel)]="plan.startDate"
                      dateFormat="mm/dd/yy"
                      name="periodStartDate-{{ i }}"
                      showIcon
                      (onSelect)="submitLoan()"
                      pTooltip="Custom start date for term {{ i + 1 }}."
                      tooltipPosition="top"
                    ></p-calendar>
                  </td>
                  <td>
                    <p-calendar
                      [(ngModel)]="plan.endDate"
                      dateFormat="mm/dd/yy"
                      name="periodEndDate-{{ i }}"
                      showIcon
                      (onSelect)="repaymentPlanEndDateChange(i)"
                      pTooltip="Custom end date for term {{ i + 1 }}."
                      tooltipPosition="top"
                    ></p-calendar>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </p-card>
      </div>
    </div>
  </p-tabPanel>

  <!-- Balance Modifications Tab -->
  <p-tabPanel header="Balance Modifications">
    <div class="grid">
      <div class="col-12">
        <p-card>
          <div class="p-fluid">
            <table
              *ngIf="loan.balanceModifications.length > 0"
              class="p-datatable p-component"
            >
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="
                    let balanceModification of loan.balanceModifications;
                    let i = index
                  "
                >
                  <!-- Date -->
                  <td>
                    <p-calendar
                      [(ngModel)]="balanceModification.date"
                      dateFormat="mm/dd/yy"
                      name="balanceModificationDate-{{ i }}"
                      showIcon
                      (onSelect)="balanceModificationChanged()"
                      pTooltip="Date of the balance modification."
                      tooltipPosition="top"
                    ></p-calendar>
                  </td>
                  <!-- Type -->
                  <td>
                    <p-dropdown
                      [(ngModel)]="balanceModification.type"
                      name="balanceModificationType-{{ i }}"
                      [options]="balanceIncreaseType"
                      placeholder="Select a type"
                      (ngModelChange)="balanceModificationChanged()"
                      pTooltip="Type of balance modification. E.g., 'Increase', 'Decrease'"
                      tooltipPosition="top"
                    ></p-dropdown>
                  </td>
                  <!-- Amount -->
                  <td>
                    <p-inputNumber
                      [(ngModel)]="balanceModification.amount"
                      name="balanceModificationAmount-{{ i }}"
                      mode="currency"
                      currency="USD"
                      locale="en-US"
                      (ngModelChange)="balanceModificationChanged()"
                      pTooltip="Amount of the balance modification. E.g., $500"
                      tooltipPosition="top"
                    ></p-inputNumber>
                  </td>
                  <!-- Remove Button -->
                  <td>
                    <p-button
                      icon="pi pi-trash"
                      class="p-button-rounded p-button-danger"
                      (onClick)="deleteBalanceModificationRow(i)"
                      pTooltip="Remove this balance modification."
                      tooltipPosition="top"
                    ></p-button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="p-mt-2">
              <p-button
                label="Add Balance Modification Row"
                icon="pi pi-plus"
                class="p-button-success"
                (onClick)="addBalanceModificationRow()"
                pTooltip="Add a new balance modification."
                tooltipPosition="top"
              ></p-button>
            </div>
          </div>
        </p-card>
      </div>
    </div>
  </p-tabPanel>
</p-tabView>

<!-- Repayment Plan at the Bottom -->
<div *ngIf="showTable">
  <!-- Repayment Plan Card -->
  <p-card header="Repayment Plan Summary">
    <!-- Summary Tags -->
    <div class="grid">
      <div class="col-3">
        <p-tag
          severity="success"
          value="Term In Months: {{ amortization?.loanTermInMonths }}"
        ></p-tag>
      </div>
      <div class="col-3">
        <p-tag
          severity="success"
          value="APR: {{ amortization?.apr?.toDecimalPlaces(4) }}%"
        ></p-tag>
      </div>
      <div class="col-3">
        <p-tag
          severity="success"
          value="Total Charged Interest: ${{
            amortization?.totalChargedInterestRounded?.toNumber()
          }}"
        ></p-tag>
      </div>
      <div class="col-3">
        <p-tag
          severity="success"
          value="Total Loan Amount: ${{
            amortization?.totalLoanAmount?.toNumber()
          }}"
        ></p-tag>
      </div>
    </div>
    <p-divider></p-divider>

    <!-- Table Toggle Button -->
    <div class="p-text-center p-mt-3">
      <p-button
        label="Show {{ showAdvancedTable ? 'Simple' : 'Advanced' }} Table"
        icon="pi pi-table"
        (onClick)="toggleAdvancedTable()"
      ></p-button>
    </div>
    <p-divider></p-divider>

    <!-- Repayment Plan Table -->
    <p-table [value]="repaymentPlan">
      <ng-template pTemplate="header">
        <tr>
          <th>Period</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Bill Open Date</th>
          <th>Bill Due Date</th>
          <th>Interest Rate</th>
          <th>Total Interest</th>
          <th>Principal</th>
          <th>Total Payment</th>
          <th>End Balance</th>
          <!-- Advanced Columns -->
          <th *ngIf="showAdvancedTable">Start Balance</th>
          <th *ngIf="showAdvancedTable">Balance Modification Amount</th>
          <th *ngIf="showAdvancedTable">Interest</th>
          <th *ngIf="showAdvancedTable">Billed Deferred Interest</th>
          <th *ngIf="showAdvancedTable">Real Interest</th>
          <th *ngIf="showAdvancedTable">Rounding Error</th>
          <th *ngIf="showAdvancedTable">Per Diem</th>
          <th *ngIf="showAdvancedTable">Days</th>
          <th *ngIf="showAdvancedTable">Unbilled Interest</th>
          <th *ngIf="showAdvancedTable">Total Deferred Interest</th>
          <th *ngIf="showAdvancedTable">
            Deferred Interest For Current Period
          </th>
          <th *ngIf="showAdvancedTable">Pre Bill Days</th>
          <th *ngIf="showAdvancedTable">Due Bill Days</th>
          <th *ngIf="showAdvancedTable">Metadata</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-plan>
        <tr>
          <td>{{ plan.period }}</td>
          <td>{{ plan.periodStartDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodEndDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodBillOpenDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodBillDueDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodInterestRate }}%</td>
          <td>{{ plan.totalInterestForPeriod | currency }}</td>
          <td>{{ plan.principal | currency }}</td>
          <td>{{ plan.totalPayment | currency }}</td>
          <td>{{ plan.endBalance | currency }}</td>
          <!-- Advanced Columns -->
          <td *ngIf="showAdvancedTable">
            {{ plan.startBalance | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.balanceModificationAmount | currency }}
          </td>
          <td *ngIf="showAdvancedTable">{{ plan.interest | currency }}</td>
          <td *ngIf="showAdvancedTable">
            {{ plan.billedDeferredInterest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.realInterest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.interestRoundingError }}
          </td>
          <td *ngIf="showAdvancedTable">{{ plan.perDiem | currency }}</td>
          <td *ngIf="showAdvancedTable">{{ plan.daysInPeriod }}</td>
          <td *ngIf="showAdvancedTable">
            {{ plan.unbilledInterestDueToRounding | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.totalDeferredInterest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.deferredInterestFromCurrentPeriod | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.prebillDaysConfiguration }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.billDueDaysAfterPeriodEndConfiguration }}
          </td>
          <td *ngIf="showAdvancedTable">
            <table class="metadata-table">
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of plan.metadata | keyvalue">
                  <td>{{ item.key }}</td>
                  <td>{{ item.value }}</td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Truth in Lending Disclosure Statement Button -->
    <p-divider></p-divider>
    <div class="p-mt-3 p-text-center">
      <p-button
        label="Truth in Lending Disclosure Statement"
        icon="pi pi-file"
        (onClick)="showTilaDialogButton()"
        pTooltip="View the Truth in Lending Disclosure Statement."
        tooltipPosition="top"
      ></p-button>
    </div>
  </p-card>

  <!-- Truth in Lending Disclosure Statement Dialog -->
  <p-dialog
    header="Truth in Lending Disclosure Statement"
    [modal]="true"
    [(visible)]="showTilaDialog"
    [style]="{ width: '90%' }"
  >
    <app-tila-disclosure
      [showTitle]="false"
      [tilaDisclosures]="tilaDisclosures"
      [lenderName]="lenderName"
      [borrowerName]="borrowerName"
      [loanDate]="loanDate"
      [loanNumber]="loanNumber"
      [collateralDescription]="collateralDescription"
      [prepaymentPenalty]="prepaymentPenalty"
      [latePaymentGracePeriod]="latePaymentGracePeriod"
      [latePaymentFee]="latePaymentFee"
      [assumable]="assumable"
    ></app-tila-disclosure>
  </p-dialog>
</div>
