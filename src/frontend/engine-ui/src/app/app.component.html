<div class="p-grid p-justify-center p-mt-4">
  <div class="p-col-12 p-md-10">
    <!-- Main Card Wrapper -->
    <div class="card">
      <h2 class="p-text-center p-mb-4">Loan Parameters</h2>

      <!-- Loan Parameters Form -->
      <form class="p-fluid">
        <!-- Loan Details Card -->
        <p-card header="Loan Details">
          <div class="p-grid">
            <!-- Principal Amount -->
            <div class="p-field p-col-12 p-md-4">
              <label for="principal">Principal Amount</label>
              <input
                id="principal"
                type="number"
                pInputText
                [(ngModel)]="loan.principal"
                name="principal"
                placeholder="Enter principal amount"
              />
            </div>

            <!-- Interest Rate (%) -->
            <div class="p-field p-col-12 p-md-4">
              <label for="interestRate">Interest Rate (%)</label>
              <input
                id="interestRate"
                type="number"
                pInputText
                [(ngModel)]="loan.interestRate"
                name="interestRate"
                placeholder="Enter interest rate"
              />
            </div>

            <!-- Term (Months) -->
            <div class="p-field p-col-12 p-md-4">
              <label for="term">Term (Months)</label>
              <input
                id="term"
                type="number"
                pInputText
                [(ngModel)]="loan.term"
                name="term"
                placeholder="Enter loan term in months"
              />
            </div>

            <!-- Start Date -->
            <div class="p-field p-col-12 p-md-6">
              <label for="startDate">Start Date</label>
              <p-calendar
                [(ngModel)]="loan.startDate"
                name="startDate"
                dateFormat="mm/dd/yy"
                showIcon
              ></p-calendar>
            </div>

            <!-- Calendar Type -->
            <div class="p-field p-col-12 p-md-6">
              <label for="calendarType">Calendar Type</label>
              <p-dropdown
                [(ngModel)]="loan.calendarType"
                name="calendarType"
                [options]="calendarTypes"
                placeholder="Select a calendar type"
              ></p-dropdown>
            </div>
          </div>
        </p-card>

        <!-- Advanced Options Card -->
        <p-card header="Advanced Options" class="p-mt-3">
          <p-fieldset legend="Advanced Settings" [toggleable]="true">
            <div class="p-grid">
              <!-- Rounding Method -->
              <div class="p-field p-col-12 p-md-4">
                <label for="roundingMethod">Rounding Method</label>
                <p-dropdown
                  [(ngModel)]="loan.roundingMethod"
                  name="roundingMethod"
                  [options]="roundingMethods"
                  placeholder="Select a rounding method"
                ></p-dropdown>
              </div>

              <!-- Flush Unbilled Interest Method -->
              <div class="p-field p-col-12 p-md-4">
                <label for="flushMethod">Flush Unbilled Interest Method</label>
                <p-dropdown
                  [(ngModel)]="loan.flushMethod"
                  name="flushMethod"
                  [options]="flushMethods"
                  placeholder="Select a flush method"
                ></p-dropdown>
              </div>

              <!-- Rounding Precision -->
              <div class="p-field p-col-12 p-md-4">
                <label for="roundingPrecision">Rounding Precision</label>
                <input
                  id="roundingPrecision"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.roundingPrecision"
                  name="roundingPrecision"
                  placeholder="Enter rounding precision"
                />
              </div>

              <!-- Flush Threshold (only if flush method is not 'none') -->
              <div
                class="p-field p-col-12 p-md-6"
                *ngIf="loan.flushMethod !== 'none'"
              >
                <label for="flushThreshold">Flush Threshold</label>
                <input
                  id="flushThreshold"
                  type="number"
                  pInputText
                  [(ngModel)]="loan.flushThreshold"
                  name="flushThreshold"
                  placeholder="Enter flush threshold"
                />
              </div>
            </div>
          </p-fieldset>
        </p-card>

        <!-- Submit Button -->
        <div class="p-field p-col-12 p-text-center p-mt-3">
          <p-button
            label="Submit"
            icon="pi pi-check"
            (onClick)="submitLoan()"
          ></p-button>
        </div>
      </form>

      <!-- Repayment Plan Table -->
      <div *ngIf="showTable" class="p-mt-4">
        <!-- Table Toggle Button -->
        <div class="p-text-center p-mt-3">
          <p-button
            label="Show {{ showAdvancedTable ? 'Simple' : 'Advanced' }} Table"
            icon="pi pi-table"
            (onClick)="toggleAdvancedTable()"
          ></p-button>
        </div>
        <!-- Repayment Plan Card -->
        <p-card header="Repayment Plan" class="p-mt-3">
          <p-table [value]="repaymentPlan">
            <ng-template pTemplate="header">
              <tr>
                <th>Period</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Interest Rate</th>
                <th>Total Interest</th>
                <th>Principal</th>
                <th>Total Payment</th>
                <!-- Advanced Columns -->
                <th *ngIf="showAdvancedTable">Interest</th>
                <th *ngIf="showAdvancedTable">Real Interest</th>
                <th *ngIf="showAdvancedTable">Rounding Error</th>
                <th *ngIf="showAdvancedTable">Per Diem</th>
                <th *ngIf="showAdvancedTable">Days</th>
                <th *ngIf="showAdvancedTable">Start Balance</th>
                <th *ngIf="showAdvancedTable">End Balance</th>
                <th *ngIf="showAdvancedTable">Unbilled Interest</th>
                <th *ngIf="showAdvancedTable">Metadata</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-plan>
              <tr>
                <td>{{ plan.period }}</td>
                <td>{{ plan.periodStartDate | date : "MM/dd/yyyy" }}</td>
                <td>{{ plan.periodEndDate | date : "MM/dd/yyyy" }}</td>
                <td>{{ plan.periodInterestRate }}%</td>
                <td>
                  {{ plan.totalInterestForPeriod | currency }}
                </td>

                <td>{{ plan.principal | currency }}</td>
                <td>{{ plan.totalPayment | currency }}</td>
                <!-- Advanced Columns -->
                <td *ngIf="showAdvancedTable">
                  {{ plan.interest | currency }}
                </td>
                <td *ngIf="showAdvancedTable">
                  {{ plan.realInterest }}
                </td>
                <td *ngIf="showAdvancedTable">
                  {{ plan.interestRoundingError }}
                </td>
                <td *ngIf="showAdvancedTable">
                  {{ plan.perDiem | currency }}
                </td>
                <td *ngIf="showAdvancedTable">{{ plan.daysInPeriod }}</td>
                <td *ngIf="showAdvancedTable">
                  {{ plan.startBalance | currency }}
                </td>
                <td *ngIf="showAdvancedTable">
                  {{ plan.endBalance | currency }}
                </td>
                <td *ngIf="showAdvancedTable">
                  {{ plan.unbilledInterestDueToRounding }}
                </td>
                <td *ngIf="showAdvancedTable">
                  <table class="metadata-table">
                    <thead>
                      <tr>
                        <th>Key</th>
                        <th>Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of plan.metadata | keyvalue">
                        <td>{{ item.key }}</td>
                        <td>{{ item.value }}</td>
                      </tr>
                    </tbody>
                  </table>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>
    </div>
  </div>
</div>
