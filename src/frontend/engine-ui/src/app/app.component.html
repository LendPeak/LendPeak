<app-toolbar
  [snapshotDate]="snapshotDate"
  (snapshotDateChange)="onSnapshotDateChange($event)"
  [toolbarActions]="toolbarActions"
  (saveUIState)="saveUIState()"
  (resetUIState)="resetUIState()"
></app-toolbar>

<!-- TabView -->
<p-tabView>
  <!-- Basic Loan Info Tab -->
  <p-tabPanel header="Basic Loan Info">
    <form>
      <div class="grid">
        <div class="col-12">
          <p-card header="Loan Details">
            <div class="grid p-fluid">
              <!-- Principal Amount -->
              <div class="field col-6">
                <label for="principal">
                  Principal Amount
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, principalTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="principal"
                  [(ngModel)]="loan.principal"
                  name="principal"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="submitLoan()"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #principalTooltip>
                  The initial amount of the loan. E.g., $100,000
                </p-overlayPanel>
              </div>

              <!-- Origination Fee -->
              <div class="field col-6">
                <label for="originationFee">
                  Origination Fee
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, originationFeeTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="originationFee"
                  [(ngModel)]="loan.originationFee"
                  name="originationFee"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="submitLoan()"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #originationFeeTooltip>
                  The fee charged by the lender for processing the loan. E.g.,
                  $1,000
                </p-overlayPanel>
              </div>

              <!-- Interest Rate (%) -->
              <div class="field col-6">
                <label for="interestRate">
                  Interest Rate (%)
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, interestRateTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="interestRate"
                  [(ngModel)]="loan.interestRate"
                  name="interestRate"
                  mode="decimal"
                  minFractionDigits="2"
                  suffix="%"
                  (ngModelChange)="submitLoan()"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #interestRateTooltip>
                  Annual interest rate for the loan. E.g., 5%
                </p-overlayPanel>
              </div>

              <!-- Term (Months) -->
              <div class="field col-6">
                <label for="term">
                  Term ({{ amortization?.loanTermInMonths }} months)
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, termTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="term"
                  [(ngModel)]="loan.term"
                  name="term"
                  (ngModelChange)="updateTerm()"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #termTooltip>
                  Number of periods for the loan term. E.g., 12
                </p-overlayPanel>
              </div>

              <!-- Start Date -->
              <div class="field col-4">
                <label for="startDate">
                  Start Date
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, startDateTooltip)"
                  ></i>
                </label>
                <p-calendar
                  id="startDate"
                  [(ngModel)]="loan.startDate"
                  name="startDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                  (ngModelChange)="updateStartDate()"
                ></p-calendar>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #startDateTooltip>
                  The date when the loan starts. E.g., 01/01/2024
                </p-overlayPanel>
              </div>

              <!-- First Payment Date -->
              <div class="field col-4">
                <label for="firstPaymentDate">
                  First Payment Date
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, firstPaymentDateTooltip)"
                  ></i>
                </label>
                <p-calendar
                  id="firstPaymentDate"
                  [(ngModel)]="loan.firstPaymentDate"
                  name="firstPaymentDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                  (ngModelChange)="submitLoan()"
                ></p-calendar>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #firstPaymentDateTooltip>
                  The date of the first payment. E.g., 02/01/2024
                </p-overlayPanel>
              </div>

              <!-- End Date -->
              <div class="field col-4">
                <label for="endDate">
                  End Date
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, endDateTooltip)"
                  ></i>
                </label>
                <p-calendar
                  id="endDate"
                  [(ngModel)]="loan.endDate"
                  name="endDate"
                  dateFormat="mm/dd/yy"
                  showIcon
                  (ngModelChange)="submitLoan()"
                ></p-calendar>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #endDateTooltip>
                  The date when the loan ends. Calculated automatically if not
                  set.
                </p-overlayPanel>
              </div>
            </div>
          </p-card>
        </div>
      </div>
    </form>
  </p-tabPanel>

  <!-- Overrides Tab -->
  <p-tabPanel header="Overrides">
    <div class="grid">
      <div class="col-12">
        <p-accordion multiple="true">
          <!-- Interest Rate -->
          <p-accordionTab header="Interest Rate">
            <div class="p-fluid">
              <table
                *ngIf="loan.ratesSchedule.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Interest Rate (%)</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let rate of loan.ratesSchedule; let i = index">
                    <!-- Start Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="rate.startDate"
                        name="overrideStartDate-{{ i }}"
                        dateFormat="mm/dd/yy"
                        showIcon
                        (ngModelChange)="submitLoan()"
                      ></p-calendar>
                    </td>
                    <!-- End Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="rate.endDate"
                        name="overrideEndDate-{{ i }}"
                        dateFormat="mm/dd/yy"
                        showIcon
                        (ngModelChange)="submitLoan()"
                      ></p-calendar>
                    </td>
                    <!-- Interest Rate -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="rate.annualInterestRate"
                        name="overrideInterestRate-{{ i }}"
                        mode="decimal"
                        minFractionDigits="2"
                        suffix="%"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeRateOverride(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Rate Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addRateOverride()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Term Payment Amount -->
          <p-accordionTab header="Term Payment Amount">
            <div class="p-fluid">
              <table
                *ngIf="loan.termPaymentAmountOverride.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Payment Amount</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let paymentConfiguration of loan.termPaymentAmountOverride;
                      let i = index
                    "
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="paymentConfiguration.termNumber"
                        name="overrideTermPayment-term{{ i }}"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Payment Amount -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="paymentConfiguration.paymentAmount"
                        name="overrideTermPaymentAmount-{{ i }}"
                        mode="currency"
                        currency="USD"
                        locale="en-US"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeTermPaymentAmountOverride(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Term Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addTermPaymentAmountOverride()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Change Payment Date -->
          <p-accordionTab header="Change Payment Date">
            <div class="p-fluid">
              <table
                *ngIf="loan.changePaymentDates.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>New Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let changePaymentDate of loan.changePaymentDates;
                      let i = index
                    "
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="changePaymentDate.termNumber"
                        name="changePaymentDate-term{{ i }}"
                        (ngModelChange)="
                          updateTermForCPD(i, changePaymentDate.termNumber)
                        "
                      ></p-inputNumber>
                    </td>
                    <!-- New Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="changePaymentDate.newDate"
                        name="changePaymentDateNewDate-{{ i }}"
                        dateFormat="mm/dd/yy"
                        showIcon
                        (ngModelChange)="submitLoan()"
                      ></p-calendar>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeChangePaymentDate(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add Change Payment Date Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addNewChangePaymentTermRow()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Pre Bill Day Term -->
          <p-accordionTab header="Pre Bill Day Term">
            <div class="p-fluid">
              <table
                *ngIf="loan.preBillDays.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Days</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let preBillDay of loan.preBillDays; let i = index"
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="preBillDay.termNumber"
                        name="preBillDayConfiguration-term{{ i }}"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Days -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="preBillDay.preBillDays"
                        name="prebillDays-day-{{ i }}"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removePreBillDayTerm(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Term Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addPrebillDayTermRow()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Due Bill Day Term -->
          <p-accordionTab header="Due Bill Day Term">
            <div class="p-fluid">
              <table
                *ngIf="loan.dueBillDays.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Days</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let dueBillDay of loan.dueBillDays; let i = index"
                  >
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="dueBillDay.termNumber"
                        name="dueBillDayConfiguration-term{{ i }}"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Days -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="dueBillDay.daysDueAfterPeriodEnd"
                        name="duebillDays-day-{{ i }}"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeDueBillDayTerm(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add New Term Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addDueBillDayTermRow()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Balance Modifications -->
          <p-accordionTab header="Balance Modifications">
            <div class="p-fluid">
              <table
                *ngIf="loan.balanceModifications.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let balanceModification of loan.balanceModifications;
                      let i = index
                    "
                  >
                    <!-- Date -->
                    <td>
                      <p-calendar
                        [(ngModel)]="balanceModification.date"
                        dateFormat="mm/dd/yy"
                        name="balanceModificationDate-{{ i }}"
                        showIcon
                        (ngModelChange)="balanceModificationChanged()"
                      ></p-calendar>
                    </td>
                    <!-- Type -->
                    <td>
                      <p-dropdown
                        [(ngModel)]="balanceModification.type"
                        name="balanceModificationType-{{ i }}"
                        [options]="balanceIncreaseType"
                        placeholder="Select a type"
                        (ngModelChange)="balanceModificationChanged()"
                      ></p-dropdown>
                    </td>
                    <!-- Amount -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="balanceModification.amount"
                        name="balanceModificationAmount-{{ i }}"
                        mode="currency"
                        currency="USD"
                        locale="en-US"
                        (ngModelChange)="balanceModificationChanged()"
                      ></p-inputNumber>
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="deleteBalanceModificationRow(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add Balance Modification Row"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addBalanceModificationRow()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Fees That Apply to All Terms -->
          <p-accordionTab header="Fees That Apply to All Terms">
            <div class="p-fluid">
              <table
                *ngIf="loan.feesForAllTerms.length > 0"
                class="p-datatable p-component"
              >
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Amount / Percentage</th>
                    <th>Based On</th>
                    <th>Description</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let fee of loan.feesForAllTerms; let i = index">
                    <!-- Fee Type -->
                    <td>
                      <p-dropdown
                        [(ngModel)]="fee.type"
                        [options]="[
                          { label: 'Fixed', value: 'fixed' },
                          { label: 'Percentage', value: 'percentage' }
                        ]"
                        (ngModelChange)="submitLoan()"
                      ></p-dropdown>
                    </td>
                    <!-- Amount or Percentage -->
                    <td>
                      <ng-container *ngIf="fee.type === 'fixed'">
                        <p-inputNumber
                          [(ngModel)]="fee.amount"
                          mode="currency"
                          currency="USD"
                          locale="en-US"
                          (ngModelChange)="submitLoan()"
                        ></p-inputNumber>
                      </ng-container>
                      <ng-container *ngIf="fee.type === 'percentage'">
                        <p-inputNumber
                          [(ngModel)]="fee.percentage"
                          mode="decimal"
                          minFractionDigits="2"
                          suffix="%"
                          (ngModelChange)="submitLoan()"
                        ></p-inputNumber>
                      </ng-container>
                    </td>
                    <!-- Based On -->
                    <td>
                      <ng-container *ngIf="fee.type === 'percentage'">
                        <p-dropdown
                          [(ngModel)]="fee.basedOn"
                          [options]="[
                            { label: 'Interest', value: 'interest' },
                            { label: 'Principal', value: 'principal' },
                            { label: 'Total Payment', value: 'totalPayment' }
                          ]"
                          (ngModelChange)="submitLoan()"
                        ></p-dropdown>
                      </ng-container>
                    </td>
                    <!-- Description -->
                    <td>
                      <input
                        type="text"
                        [(ngModel)]="fee.description"
                        (ngModelChange)="submitLoan()"
                      />
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeFeeForAllTerms(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add Fee"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addFeeForAllTerms()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>

          <!-- Fees Per Term -->
          <p-accordionTab header="Fees Per Term">
            <div class="p-fluid">
              <table class="p-datatable p-component">
                <thead>
                  <tr>
                    <th>Term Number</th>
                    <th>Type</th>
                    <th>Amount / Percentage</th>
                    <th>Based On</th>
                    <th>Description</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let fee of loan.feesPerTerm; let i = index">
                    <!-- Term Number -->
                    <td>
                      <p-inputNumber
                        [(ngModel)]="fee.termNumber"
                        (ngModelChange)="submitLoan()"
                      ></p-inputNumber>
                    </td>
                    <!-- Fee Type -->
                    <td>
                      <p-dropdown
                        [(ngModel)]="fee.type"
                        [options]="[
                          { label: 'Fixed', value: 'fixed' },
                          { label: 'Percentage', value: 'percentage' }
                        ]"
                        (ngModelChange)="submitLoan()"
                      ></p-dropdown>
                    </td>
                    <!-- Amount or Percentage -->
                    <td>
                      <ng-container *ngIf="fee.type === 'fixed'">
                        <p-inputNumber
                          [(ngModel)]="fee.amount"
                          mode="currency"
                          currency="USD"
                          locale="en-US"
                          (ngModelChange)="submitLoan()"
                        ></p-inputNumber>
                      </ng-container>
                      <ng-container *ngIf="fee.type === 'percentage'">
                        <p-inputNumber
                          [(ngModel)]="fee.percentage"
                          mode="decimal"
                          minFractionDigits="2"
                          suffix="%"
                          (ngModelChange)="submitLoan()"
                        ></p-inputNumber>
                      </ng-container>
                    </td>
                    <!-- Based On -->
                    <td>
                      <ng-container *ngIf="fee.type === 'percentage'">
                        <p-dropdown
                          [(ngModel)]="fee.basedOn"
                          [options]="[
                            { label: 'Interest', value: 'interest' },
                            { label: 'Principal', value: 'principal' },
                            { label: 'Total Payment', value: 'totalPayment' }
                          ]"
                          (ngModelChange)="submitLoan()"
                        ></p-dropdown>
                      </ng-container>
                    </td>
                    <!-- Description -->
                    <td>
                      <input
                        type="text"
                        [(ngModel)]="fee.description"
                        (ngModelChange)="submitLoan()"
                      />
                    </td>
                    <!-- Remove Button -->
                    <td>
                      <p-button
                        icon="pi pi-trash"
                        class="p-button-rounded p-button-danger"
                        (onClick)="removeFeePerTerm(i)"
                      ></p-button>
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="p-mt-2">
                <p-button
                  label="Add Fee"
                  icon="pi pi-plus"
                  class="p-button-success"
                  (onClick)="addFeePerTerm()"
                ></p-button>
              </div>
            </div>
          </p-accordionTab>
        </p-accordion>
      </div>
    </div>
  </p-tabPanel>

  <!-- Advanced Settings Tab -->
  <p-tabPanel header="Advanced Settings">
    <div class="grid">
      <div class="col-12">
        <!-- Replaced p-card with p-accordion -->
        <p-accordion multiple="true">
          <!-- Term Configuration Section -->
          <p-accordionTab header="Term Configuration">
            <div class="p-fluid">
              <div class="field grid">
                <!-- Term Period Unit -->
                <div class="field col-6">
                  <label for="termPeriodUnit">
                    Term Period Unit
                    <i
                      class="pi pi-info-circle tooltip-icon"
                      (click)="showTooltip($event, termPeriodUnitTooltip)"
                    ></i>
                  </label>
                  <p-dropdown
                    id="termPeriodUnit"
                    [(ngModel)]="loan.termPeriodDefinition.unit"
                    name="termPeriodUnit"
                    [options]="termPeriodUnits"
                    placeholder="Select a term period unit"
                    (ngModelChange)="termPeriodDefinitionChange()"
                  ></p-dropdown>
                  <!-- Tooltip Overlay -->
                  <p-overlayPanel #termPeriodUnitTooltip>
                    Defines the unit of time for each term period. For example,
                    select "Month" for monthly payments.
                  </p-overlayPanel>
                </div>

                <!-- Term Period Count -->
                <div class="field col-6">
                  <label for="termPeriodCount">
                    Term Period Count
                    <i
                      class="pi pi-info-circle tooltip-icon"
                      (click)="showTooltip($event, termPeriodCountTooltip)"
                    ></i>
                  </label>
                  <p-inputNumber
                    id="termPeriodCount"
                    [(ngModel)]="loan.termPeriodDefinition.count[0]"
                    name="termPeriodCount"
                    (ngModelChange)="termPeriodDefinitionChange()"
                  ></p-inputNumber>
                  <!-- Tooltip Overlay -->
                  <p-overlayPanel #termPeriodCountTooltip>
                    Number of units per term period. For example, enter "1" for
                    payments every one unit (e.g., every 1 month).
                  </p-overlayPanel>
                </div>

                <!-- Calendar Type -->
                <div class="field col-6">
                  <label for="calendarType">
                    Calendar Type
                    <i
                      class="pi pi-info-circle tooltip-icon"
                      (click)="showTooltip($event, calendarTypeTooltip)"
                    ></i>
                  </label>
                  <p-dropdown
                    id="calendarType"
                    [(ngModel)]="loan.calendarType"
                    name="calendarType"
                    [options]="calendarTypes"
                    placeholder="Select a calendar type"
                    (ngModelChange)="submitLoan()"
                  ></p-dropdown>
                  <!-- Tooltip Overlay -->
                  <p-overlayPanel #calendarTypeTooltip>
                    <div class="tooltip-content">
                      <p>
                        Determines the calendar system used for the loan
                        schedule. Choose between different calendar conventions:
                      </p>
                      <ul>
                        <li>
                          <strong>Actual/Actual</strong>: Calculates interest
                          based on the actual number of days in each period and
                          the actual number of days in the year.
                        </li>
                        <li>
                          <strong>Actual/360</strong>: Calculates interest based
                          on the actual number of days in each period but
                          assumes a 360-day year.
                        </li>
                        <li>
                          <strong>Actual/365</strong>: Calculates interest based
                          on the actual number of days in each period but
                          assumes a 365-day year.
                        </li>
                        <li>
                          <strong>30/360</strong>: Assumes each month has 30
                          days and each year has 360 days.
                        </li>
                        <li>
                          <strong>30/Actual</strong>: Assumes each month has 30
                          days but uses the actual number of days in the year.
                        </li>
                      </ul>
                    </div>
                  </p-overlayPanel>
                </div>
              </div>
            </div>
          </p-accordionTab>

          <!-- Payment Settings Section -->
          <p-accordionTab header="Payment Settings">
            <div class="p-fluid">
              <!-- Term Payment Amount -->
              <div class="field">
                <label for="termPaymentAmount">
                  Term Payment Amount
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, termPaymentAmountTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="termPaymentAmount"
                  [(ngModel)]="loan.termPaymentAmount"
                  name="termPaymentAmount"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="onTermPaymentAmountChange($event)"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #termPaymentAmountTooltip>
                  Override the calculated payment amount per term. For example,
                  enter "$1,200" to set a fixed payment amount.
                </p-overlayPanel>
              </div>
            </div>
          </p-accordionTab>

          <!-- Billing Settings Section -->
          <p-accordionTab header="Billing Settings">
            <div class="p-fluid">
              <div class="field grid">
                <!-- Default Pre Bill Days -->
                <div class="field col-6">
                  <label for="defaultPreBillDaysConfiguration">
                    Default Pre Bill Days
                    <i
                      class="pi pi-info-circle tooltip-icon"
                      (click)="showTooltip($event, defaultPreBillDaysTooltip)"
                    ></i>
                  </label>
                  <p-inputNumber
                    id="defaultPreBillDaysConfiguration"
                    [(ngModel)]="loan.defaultPreBillDaysConfiguration"
                    name="defaultPreBillDaysConfiguration"
                    (ngModelChange)="submitLoan()"
                  ></p-inputNumber>
                  <!-- Tooltip Overlay -->
                  <p-overlayPanel #defaultPreBillDaysTooltip>
                    Number of days before the period end to open the bill by
                    default. For example, enter "5" to open the bill 5 days
                    before the period ends.
                  </p-overlayPanel>
                </div>

                <!-- Default Due Date Days -->
                <div class="field col-6">
                  <label for="defaultBillDueDaysAfterPeriodEndConfiguration">
                    Default Due Date Days
                    <i
                      class="pi pi-info-circle tooltip-icon"
                      (click)="showTooltip($event, defaultDueDateDaysTooltip)"
                    ></i>
                  </label>
                  <p-inputNumber
                    id="defaultBillDueDaysAfterPeriodEndConfiguration"
                    [(ngModel)]="
                      loan.defaultBillDueDaysAfterPeriodEndConfiguration
                    "
                    name="defaultBillDueDaysAfterPeriodEndConfiguration"
                    (ngModelChange)="submitLoan()"
                  ></p-inputNumber>
                  <!-- Tooltip Overlay -->
                  <p-overlayPanel #defaultDueDateDaysTooltip>
                    Number of days after the period end when the payment is due
                    by default. For example, enter "30" for payments due 30 days
                    after the period ends.
                  </p-overlayPanel>
                </div>
              </div>
            </div>
          </p-accordionTab>

          <!-- Interest Settings Section -->
          <p-accordionTab header="Interest Settings">
            <div class="p-fluid">
              <!-- Allow Rates Above 100% -->
              <div class="field-checkbox">
                <p-checkbox
                  [(ngModel)]="loan.allowRateAbove100"
                  name="allowRateAbove100"
                  binary="true"
                  (ngModelChange)="submitLoan()"
                ></p-checkbox>
                <label for="allowRateAbove100">
                  Allow rates above 100%
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, allowRateAbove100Tooltip)"
                  ></i>
                </label>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #allowRateAbove100Tooltip>
                  Enable this option to allow setting interest rates higher than
                  100%.
                </p-overlayPanel>
              </div>

              <!-- Unbilled Interest Flush Method -->
              <div class="field">
                <label for="flushMethod">
                  Unbilled Interest Flush Method
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, flushMethodTooltip)"
                  ></i>
                </label>
                <p-dropdown
                  id="flushMethod"
                  [(ngModel)]="loan.flushMethod"
                  name="flushMethod"
                  [options]="flushMethods"
                  placeholder="Select a flush method"
                  (ngModelChange)="submitLoan()"
                ></p-dropdown>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #flushMethodTooltip>
                  Determines how unbilled interest is handled. Choose a method
                  to define when unbilled interest should be flushed.
                </p-overlayPanel>
              </div>

              <!-- Flush Threshold -->
              <div class="field" *ngIf="loan.flushMethod !== 'none'">
                <label for="flushThreshold">
                  Unbilled Interest Flush Threshold
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, flushThresholdTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="flushThreshold"
                  [(ngModel)]="loan.flushThreshold"
                  name="flushThreshold"
                  mode="currency"
                  currency="USD"
                  locale="en-US"
                  (ngModelChange)="submitLoan()"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #flushThresholdTooltip>
                  The threshold amount for flushing unbilled interest. For
                  example, enter "$0.01" to flush unbilled interest when it
                  reaches one cent.
                </p-overlayPanel>
              </div>
            </div>
          </p-accordionTab>

          <!-- Rounding Settings Section -->
          <p-accordionTab header="Rounding Settings">
            <div class="p-fluid">
              <!-- Rounding Method -->
              <div class="field">
                <label for="roundingMethod">
                  Rounding Method
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, roundingMethodTooltip)"
                  ></i>
                </label>
                <p-dropdown
                  id="roundingMethod"
                  [(ngModel)]="loan.roundingMethod"
                  name="roundingMethod"
                  [options]="roundingMethods"
                  placeholder="Select a rounding method"
                  (ngModelChange)="submitLoan()"
                ></p-dropdown>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #roundingMethodTooltip>
                  <div class="tooltip-content">
                    <p>
                      Specifies how to round calculated amounts. Options
                      include:
                    </p>
                    <ul>
                      <li>
                        <strong>Round Up:</strong> Always rounds the number up
                        to the nearest specified precision.<br />
                        <em>Example:</em> If rounding to 2 decimal places:
                        <ul>
                          <li>2.301 becomes <strong>2.31</strong></li>
                          <li>2.374 becomes <strong>2.38</strong></li>
                          <li>-2.301 becomes <strong>-2.30</strong></li>
                        </ul>
                      </li>
                      <li>
                        <strong>Round Down:</strong> Always rounds the number
                        down to the nearest specified precision.<br />
                        <em>Example:</em> If rounding to 2 decimal places:
                        <ul>
                          <li>2.399 becomes <strong>2.39</strong></li>
                          <li>2.376 becomes <strong>2.37</strong></li>
                          <li>-2.399 becomes <strong>-2.40</strong></li>
                        </ul>
                      </li>
                      <li>
                        <strong>Round Half Up:</strong> Rounds to the nearest
                        neighbor; if equidistant, rounds away from zero.<br />
                        <em>Example:</em> If rounding to 2 decimal places:
                        <ul>
                          <li>2.345 becomes <strong>2.35</strong></li>
                          <li>2.344 becomes <strong>2.34</strong></li>
                          <li>-2.345 becomes <strong>-2.35</strong></li>
                        </ul>
                      </li>
                      <li>
                        <strong>Round Half Down:</strong> Rounds to the nearest
                        neighbor; if equidistant, rounds towards zero.<br />
                        <em>Example:</em> If rounding to 2 decimal places:
                        <ul>
                          <li>2.345 becomes <strong>2.34</strong></li>
                          <li>2.346 becomes <strong>2.35</strong></li>
                          <li>-2.345 becomes <strong>-2.34</strong></li>
                        </ul>
                      </li>
                      <li>
                        <strong>Round Half Even (Bankers' Rounding):</strong>
                        Rounds to the nearest neighbor; if equidistant, rounds
                        towards the nearest even number.<br />
                        <em>Example:</em> If rounding to 2 decimal places:
                        <ul>
                          <li>
                            2.345 becomes <strong>2.34</strong> (since 4 is
                            even)
                          </li>
                          <li>
                            2.355 becomes <strong>2.36</strong> (since 6 is
                            even)
                          </li>
                          <li>-2.345 becomes <strong>-2.34</strong></li>
                        </ul>
                      </li>
                    </ul>
                  </div>
                </p-overlayPanel>
              </div>

              <!-- Rounding Precision -->
              <div class="field">
                <label for="roundingPrecision">
                  Rounding Precision (decimal places)
                  <i
                    class="pi pi-info-circle tooltip-icon"
                    (click)="showTooltip($event, roundingPrecisionTooltip)"
                  ></i>
                </label>
                <p-inputNumber
                  id="roundingPrecision"
                  [(ngModel)]="loan.roundingPrecision"
                  name="roundingPrecision"
                  (ngModelChange)="submitLoan()"
                ></p-inputNumber>
                <!-- Tooltip Overlay -->
                <p-overlayPanel #roundingPrecisionTooltip>
                  Number of decimal places to round to. For example, enter "2"
                  to round amounts to two decimal places.
                </p-overlayPanel>
              </div>
            </div>
          </p-accordionTab>
        </p-accordion>
      </div>
    </div>
  </p-tabPanel>

  <!-- Custom Periods Schedule Tab -->
  <p-tabPanel header="Custom Periods Schedule">
    <div class="grid">
      <div class="col-12">
        <p-card>
          <div class="p-mb-3">
            <p-button
              label="Create Custom Schedule"
              icon="pi pi-plus"
              class="p-button-success"
              (onClick)="createLoanRepaymentPlan()"
              pTooltip="Generate a custom periods schedule based on your inputs."
              tooltipPosition="top"
            ></p-button>
            <p-button
              label="Remove Schedule Override"
              icon="pi pi-minus"
              class="p-button-danger p-ml-2"
              (onClick)="removeLoanRepaymentPlan()"
              pTooltip="Remove the custom periods schedule override."
              tooltipPosition="top"
            ></p-button>
          </div>
          <p-divider></p-divider>
          <div class="p-fluid">
            <table
              *ngIf="loan.periodsSchedule.length > 0"
              class="p-datatable p-component"
            >
              <thead>
                <tr>
                  <th>Term</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let plan of loan.periodsSchedule; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <p-calendar
                      [(ngModel)]="plan.startDate"
                      dateFormat="mm/dd/yy"
                      name="periodStartDate-{{ i }}"
                      showIcon
                      (onSelect)="submitLoan()"
                      pTooltip="Custom start date for term {{ i + 1 }}."
                      tooltipPosition="top"
                    ></p-calendar>
                  </td>
                  <td>
                    <p-calendar
                      [(ngModel)]="plan.endDate"
                      dateFormat="mm/dd/yy"
                      name="periodEndDate-{{ i }}"
                      showIcon
                      (onSelect)="repaymentPlanEndDateChange(i)"
                      pTooltip="Custom end date for term {{ i + 1 }}."
                      tooltipPosition="top"
                    ></p-calendar>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </p-card>
      </div>
    </div>
  </p-tabPanel>

  <!-- Deposits Tab -->
  <p-tabPanel header="Deposits">
    <app-deposits
      [deposits]="loan.deposits"
      [currencyOptions]="currencyOptions"
      (depositsChange)="onDepositsChange($event)"
      (depositUpdated)="onDepositUpdated()"
    ></app-deposits>
  </p-tabPanel>

  <!-- Bills -->
  <p-tabPanel header="Bills">
  <app-bills
    [bills]="bills"
    [snapshotDate]="snapshotDate"
    (billAction)="onBillAction()"
  ></app-bills>
  </p-tabPanel>

</p-tabView>

<!-- Repayment Plan at the Bottom -->
<div *ngIf="showTable">
  <!-- Repayment Plan Card -->
  <p-card header="Repayment Plan Summary">
    <!-- Summary Tags -->
    <div class="grid">
      <div class="col-3">
        <p-tag
          severity="success"
          value="Term In Months: {{ amortization?.loanTermInMonths }}"
        ></p-tag>
      </div>
      <div class="col-3">
        <p-tag
          severity="success"
          value="APR: {{ amortization?.apr?.toDecimalPlaces(4) }}%"
        ></p-tag>
      </div>
      <div class="col-3">
        <p-tag
          severity="success"
          value="Total Charged Interest: {{
            amortization?.totalChargedInterestRounded?.toNumber() | currency
          }}"
        ></p-tag>
      </div>
      <div class="col-3">
        <p-tag
          severity="success"
          value="Total Loan Amount: {{
            amortization?.totalLoanAmount?.toNumber() | currency
          }}"
        ></p-tag>
      </div>
    </div>
    <p-divider></p-divider>

    <!-- Table Toggle Button -->
    <div class="p-text-center p-mt-3">
      <p-button
        label="Show {{ showAdvancedTable ? 'Simple' : 'Advanced' }} Table"
        icon="pi pi-table"
        (onClick)="toggleAdvancedTable()"
      ></p-button>
    </div>
    <p-divider></p-divider>

    <!-- Repayment Plan Table -->
    <p-table [value]="repaymentPlan" class="repayment-plan-table">
      <ng-template pTemplate="header">
        <tr>
          <th>Period</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Bill Open Date</th>
          <th>Bill Due Date</th>
          <th>Interest Rate</th>
          <th>Fees</th>
          <th>Total Interest</th>
          <th>Principal</th>
          <th>Total Payment</th>
          <th>End Balance</th>
          <!-- Advanced Columns -->
          <th *ngIf="showAdvancedTable">Start Balance</th>
          <th *ngIf="showAdvancedTable">Balance Modification Amount</th>
          <th *ngIf="showAdvancedTable">Interest</th>
          <th *ngIf="showAdvancedTable">Billed Deferred Interest</th>
          <th *ngIf="showAdvancedTable">Real Interest</th>
          <th *ngIf="showAdvancedTable">Rounding Error</th>
          <th *ngIf="showAdvancedTable">Per Diem</th>
          <th *ngIf="showAdvancedTable">Days</th>
          <th *ngIf="showAdvancedTable">Unbilled Interest</th>
          <th *ngIf="showAdvancedTable">Total Deferred Interest</th>
          <th *ngIf="showAdvancedTable">
            Deferred Interest For Current Period
          </th>
          <th *ngIf="showAdvancedTable">Pre Bill Days</th>
          <th *ngIf="showAdvancedTable">Due Bill Days</th>
          <th *ngIf="showAdvancedTable">Metadata</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-plan>
        <tr
          role="row"
          [attr.aria-selected]="selectedPeriods.includes(plan.period)"
          [class.even-row]="plan.period % 2 === 0"
          [class.odd-row]="plan.period % 2 !== 0"
          [class.selected-row]="selectedPeriods.includes(plan.period)"
          (click)="onRowClick(plan, $event)"
          tabindex="0"
          (keydown)="onRowKeyDown($event, plan)"
        >
          <td>{{ plan.period }}</td>
          <td>{{ plan.periodStartDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodEndDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodBillOpenDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodBillDueDate | date : "MM/dd/yyyy" }}</td>
          <td>{{ plan.periodInterestRate }}%</td>
          <td>{{ plan.fees | currency }}</td>
          <td>{{ plan.totalInterestForPeriod | currency }}</td>
          <td>{{ plan.principal | currency }}</td>
          <td>{{ plan.totalPayment | currency }}</td>
          <td>{{ plan.endBalance | currency }}</td>
          <!-- Advanced Columns -->
          <td *ngIf="showAdvancedTable">
            {{ plan.startBalance | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.balanceModificationAmount | currency }}
          </td>
          <td *ngIf="showAdvancedTable">{{ plan.interest | currency }}</td>
          <td *ngIf="showAdvancedTable">
            {{ plan.billedDeferredInterest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.realInterest }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.interestRoundingError }}
          </td>
          <td *ngIf="showAdvancedTable">{{ plan.perDiem | currency }}</td>
          <td *ngIf="showAdvancedTable">{{ plan.daysInPeriod }}</td>
          <td *ngIf="showAdvancedTable">
            {{ plan.unbilledInterestDueToRounding | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.totalDeferredInterest | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.deferredInterestFromCurrentPeriod | currency }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.prebillDaysConfiguration }}
          </td>
          <td *ngIf="showAdvancedTable">
            {{ plan.billDueDaysAfterPeriodEndConfiguration }}
          </td>
          <td *ngIf="showAdvancedTable">
            <table class="metadata-table">
              <thead>
                <tr>
                  <th>Key</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of plan.metadata | keyvalue">
                  <td>{{ item.key }}</td>
                  <td>{{ item.value }}</td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Truth in Lending Disclosure Statement Button -->
    <p-divider></p-divider>
    <div class="p-mt-3 p-text-center">
      <p-button
        label="Truth in Lending Disclosure Statement"
        icon="pi pi-file"
        (onClick)="showTilaDialogButton()"
        pTooltip="View the Truth in Lending Disclosure Statement."
        tooltipPosition="top"
      ></p-button>
    </div>
  </p-card>

  <!-- Truth in Lending Disclosure Statement Dialog -->
  <p-dialog
    header="Truth in Lending Disclosure Statement"
    [modal]="true"
    [(visible)]="showTilaDialog"
    [style]="{ width: '90%' }"
  >
    <app-tila-disclosure
      [showTitle]="false"
      [tilaDisclosures]="tilaDisclosures"
      [lenderName]="lenderName"
      [borrowerName]="borrowerName"
      [loanDate]="loanDate"
      [loanNumber]="loanNumber"
      [collateralDescription]="collateralDescription"
      [prepaymentPenalty]="prepaymentPenalty"
      [latePaymentGracePeriod]="latePaymentGracePeriod"
      [latePaymentFee]="latePaymentFee"
      [assumable]="assumable"
    ></app-tila-disclosure>
  </p-dialog>
</div>
